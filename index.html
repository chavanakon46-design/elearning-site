<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Learning System V.2 (CMS)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .iframe-container iframe { width: 100%; height: 400px; border-radius: 8px; border: none; }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg min-h-screen relative">
    
    <header class="flex justify-between items-center border-b pb-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-blue-600">‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</h1>
            <p class="text-gray-500 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</p>
        </div>
        <div id="userInfo" class="text-right hidden">
            <span id="userDisplay" class="font-bold text-gray-700"></span>
            <button onclick="logout()" class="text-xs text-red-500 underline ml-2">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </header>

    <div id="loginSection" class="text-center py-10 fade-in">
        <h2 class="text-xl mb-4">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <div class="max-w-xs mx-auto space-y-3">
            <input type="text" id="stdName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå admin)" class="w-full p-2 border rounded">
            <input type="text" id="stdClass" placeholder="‡∏ä‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏°.2/1)" class="w-full p-2 border rounded">
            <input type="number" id="stdNumber" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-2 border rounded">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="studentDashboard" class="hidden fade-in">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <button onclick="loadLessonGroup('lesson1')" class="p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 text-left">
                <div class="text-2xl mb-2">üñ•Ô∏è</div>
                <div class="font-bold">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</div>
                <div class="text-xs text-gray-500">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏°‡∏Ø</div>
            </button>
            <button onclick="loadLessonGroup('lesson2')" class="p-4 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 text-left">
                <div class="text-2xl mb-2">üõ†Ô∏è</div>
                <div class="font-bold">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</div>
                <div class="text-xs text-gray-500">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>
            </button>
            <button onclick="loadLessonGroup('lesson3')" class="p-4 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 text-left">
                <div class="text-2xl mb-2">üì°</div>
                <div class="font-bold">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</div>
                <div class="text-xs text-gray-500">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</div>
            </button>
        </div>

        <div id="contentArea" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="lessonTitle" class="text-xl font-bold">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <button onclick="backToDash()" class="text-gray-500 hover:text-gray-800">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            </div>
            
            <div id="subTopicMenu" class="flex flex-wrap gap-2 mb-6"></div>

            <div id="lessonViewer" class="bg-gray-50 p-6 rounded-lg border min-h-[300px] iframe-container">
                <p class="text-center text-gray-400 mt-10">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
            </div>
        </div>
    </div>

    <div id="adminDashboard" class="hidden fade-in">
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <h3 class="font-bold text-yellow-800">‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h3>
            <p class="text-sm text-yellow-700">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏´‡∏£‡∏∑‡∏≠‡∏ù‡∏±‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å Canva ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
        </div>

        <div class="flex gap-4 mb-4">
            <div class="w-1/3">
                <h4 class="font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ</h4>
                <div id="adminLessonList" class="bg-white border rounded h-96 overflow-y-auto p-2 space-y-2"></div>
                <button onclick="prepareNewLesson()" class="w-full mt-2 bg-green-500 text-white py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <div class="w-2/3">
                <h4 class="font-bold mb-2">‡∏ï‡∏±‡∏ß‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</h4>
                <div class="space-y-3">
                    <input type="text" id="editTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô: ‡∏Æ‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ß‡∏£‡πå)" class="w-full p-2 border rounded">
                    <select id="editCategory" class="w-full p-2 border rounded">
                        <option value="lesson1">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</option>
                        <option value="lesson2">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</option>
                        <option value="lesson3">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</option>
                    </select>
                    
                    <div class="text-xs text-gray-500">
                        ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° HTML ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î Embed ‡∏à‡∏≤‡∏Å Canva / YouTube ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                    </div>
                    <textarea id="editContent" rows="10" class="w-full p-2 border rounded font-mono text-sm" placeholder="<p>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤...</p> ‡∏´‡∏£‡∏∑‡∏≠ <iframe src='...'></iframe>"></textarea>
                    
                    <input type="hidden" id="editId"> <div class="flex gap-2">
                        <button onclick="saveLessonToDB()" class="flex-1 bg-blue-600 text-white py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button onclick="deleteLesson()" class="bg-red-500 text-white px-4 rounded">‡∏•‡∏ö</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ---
    // ‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const SUPABASE_URL = 'https://fddkpkcmkvitjkouxerg.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZGtwa2Nta3ZpdGprb3V4ZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDIxMjQsImV4cCI6MjA4MzAxODEyNH0.7OLB2igeXv3ZbLYQ2AJf-HxGpgyxqjwfAjrDG1rhP3E'; 
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Global Variables
    let currentUser = null;
    let allLessons = [];

    // --- ‡∏™‡πà‡∏ß‡∏ô Authentication ---
    async function handleLogin() {
        const name = document.getElementById('stdName').value.trim();
        const sClass = document.getElementById('stdClass').value.trim();
        const code = document.getElementById('stdNumber').value.trim();

        if (!name || !code) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Admin
        if (name.toLowerCase() === 'admin' && code === '1234') { // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin
            currentUser = { role: 'admin', name: 'Administrator' };
            switchPage('adminDashboard');
            fetchLessonsForAdmin();
            return;
        }

        // Login ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á DB ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô)
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ user ‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°
        let { data: existingUser, error } = await supabase
            .from('student_progress')
            .select('*')
            .eq('student_name', name)
            .eq('student_number', code)
            .single();

        if (!existingUser) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á user ‡πÉ‡∏´‡∏°‡πà
            const { data: newUser, error: createError } = await supabase
                .from('student_progress')
                .insert([{ student_name: name, student_class: sClass, student_number: code }])
                .select()
                .single();
            
            if (createError) return alert("Error creating user: " + createError.message);
            currentUser = newUser;
        } else {
            currentUser = existingUser;
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ login ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            await supabase.from('student_progress').update({ last_login: new Date() }).eq('id', currentUser.id);
        }

        currentUser.role = 'student';
        document.getElementById('userDisplay').innerText = `${currentUser.student_name} (${currentUser.student_class})`;
        document.getElementById('userInfo').classList.remove('hidden');
        switchPage('studentDashboard');
    }

    function logout() {
        location.reload();
    }

    function switchPage(pageId) {
        ['loginSection', 'studentDashboard', 'adminDashboard'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(pageId).classList.remove('hidden');
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Student Logic) ---
    async function loadLessonGroup(category) {
        // ‡∏î‡∏∂‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å DB ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        const { data, error } = await supabase
            .from('lessons')
            .select('*')
            .eq('category', category)
            .order('order_index', { ascending: true });

        if (error) return alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

        document.getElementById('studentDashboard').children[0].classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
        document.getElementById('contentArea').classList.remove('hidden');
        
        const menuContainer = document.getElementById('subTopicMenu');
        menuContainer.innerHTML = '';
        document.getElementById('lessonTitle').innerText = categoryToThai(category);
        document.getElementById('lessonViewer').innerHTML = '<p class="text-center text-gray-400 mt-10">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>';

        data.forEach((lesson, index) => {
            const btn = document.createElement('button');
            btn.className = "px-4 py-2 bg-white border border-blue-300 text-blue-600 rounded-full hover:bg-blue-50 transition";
            btn.innerText = `${index+1}. ${lesson.title}`;
            btn.onclick = () => showLessonContent(lesson);
            menuContainer.appendChild(btn);
        });
    }

    function showLessonContent(lesson) {
        const viewer = document.getElementById('lessonViewer');
        viewer.innerHTML = `
            <h3 class="text-2xl font-bold mb-4 border-b pb-2">${lesson.title}</h3>
            <div class="prose max-w-none">
                ${lesson.content} 
            </div>
        `;
        // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ "‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß" ‡∏•‡∏á‡πÉ‡∏ô DB ‡πÑ‡∏î‡πâ
    }

    function backToDash() {
        document.getElementById('contentArea').classList.add('hidden');
        document.getElementById('studentDashboard').children[0].classList.remove('hidden');
    }

    function categoryToThai(cat) {
        const map = { 'lesson1': '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏°‡∏Ø', 'lesson2': '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤', 'lesson3': '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3: ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' };
        return map[cat] || cat;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin Logic / CMS) ---
    async function fetchLessonsForAdmin() {
        const { data, error } = await supabase.from('lessons').select('*').order('category').order('order_index');
        if (data) {
            allLessons = data;
            renderAdminList();
        }
    }

    function renderAdminList() {
        const list = document.getElementById('adminLessonList');
        list.innerHTML = '';
        allLessons.forEach(l => {
            const item = document.createElement('div');
            item.className = "p-2 border rounded cursor-pointer hover:bg-gray-50 flex justify-between";
            item.innerHTML = `<span class="text-sm font-bold">[${l.category}]</span> <span class="truncate ml-2">${l.title}</span>`;
            item.onclick = () => loadIntoEditor(l);
            list.appendChild(item);
        });
    }

    function loadIntoEditor(lesson) {
        document.getElementById('editId').value = lesson.id;
        document.getElementById('editTitle').value = lesson.title;
        document.getElementById('editCategory').value = lesson.category;
        document.getElementById('editContent').value = lesson.content;
    }

    function prepareNewLesson() {
        document.getElementById('editId').value = '';
        document.getElementById('editTitle').value = '';
        document.getElementById('editContent').value = '';
        document.getElementById('editTitle').focus();
    }

    async function saveLessonToDB() {
        const id = document.getElementById('editId').value;
        const title = document.getElementById('editTitle').value;
        const category = document.getElementById('editCategory').value;
        const content = document.getElementById('editContent').value;

        if (!title) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠");

        const payload = { title, content, category, order_index: Date.now() }; // ‡πÉ‡∏ä‡πâ timestamp ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ

        let error;
        if (id) {
            // Update
            const res = await supabase.from('lessons').update(payload).eq('id', id);
            error = res.error;
        } else {
            // Insert
            const res = await supabase.from('lessons').insert([payload]);
            error = res.error;
        }

        if (error) alert("Error: " + error.message);
        else {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            fetchLessonsForAdmin(); // Refresh list
            prepareNewLesson();
        }
    }

    async function deleteLesson() {
        const id = document.getElementById('editId').value;
        if (!id) return;
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ?")) return;

        const { error } = await supabase.from('lessons').delete().eq('id', id);
        if (!error) {
            alert("‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            fetchLessonsForAdmin();
            prepareNewLesson();
        }
    }

</script>
</body>
</html>