<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRU DREAM E-LEARNING (V.7.0 Full Stack)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* --- 1. CORE THEME --- */
        :root {
            --primary: #4338ca; /* Indigo 700 */
            --primary-light: #6366f1;
            --accent: #f59e0b; /* Amber */
            --danger: #ef4444;
            --success: #10b981;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        body { font-family: 'Sarabun', sans-serif; background: var(--bg-body); color: var(--text-dark); margin: 0; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; min-height: 90vh; display: flex; flex-direction: column; gap: 20px; }

        /* --- 2. COMPONENTS --- */
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        
        /* Headers */
        h1, h2, h3 { margin: 0 0 10px 0; font-weight: 800; color: var(--primary); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; }

        /* Buttons (Big & Bold) */
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); filter: brightness(110%); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(67, 56, 202, 0.3); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: white; border: 2px solid #cbd5e1; color: var(--text-dark); }
        .btn-icon { padding: 8px; border-radius: 50%; }

        /* Inputs */
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }

        /* Tables */
        .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-weight: 700; color: var(--text-light); }
        td { padding: 15px; border-top: 1px solid #e2e8f0; }
        tr:hover { background: #f1f5f9; }

        /* --- 3. SPECIFIC VIEWS --- */
        
        /* Login */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 80vh; }
        .login-box { width: 100%; max-width: 450px; text-align: center; padding: 40px; border-top: 5px solid var(--primary); }
        .login-input-group { position: relative; margin: 20px 0; }
        .login-input-group input { font-size: 1.5rem; text-align: center; letter-spacing: 2px; font-weight: bold; color: var(--primary); padding: 15px; }
        .admin-secret { max-height: 0; overflow: hidden; transition: 0.5s; opacity: 0; }
        .admin-secret.show { max-height: 100px; opacity: 1; margin-top: 15px; }

        /* Grid Menus */
        .grid-lessons { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .lesson-card { cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .lesson-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .card-num { font-size: 3rem; position: absolute; right: 10px; top: 0; opacity: 0.1; font-weight: 900; }

        /* Admin Panels */
        .admin-layout { display: grid; grid-template-columns: 250px 1fr; gap: 20px; align-items: start; }
        .sidebar { background: white; padding: 15px; border-radius: 12px; height: fit-content; }
        .sidebar button { width: 100%; text-align: left; margin-bottom: 5px; justify-content: flex-start; }
        .sidebar button.active { background: #e0e7ff; color: var(--primary); }

        /* Quiz Builder */
        .quiz-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        
        /* Utilities */
        .hidden { display: none !important; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-gray { background: #f1f5f9; color: #64748b; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 99; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 30px; border-radius: 16px; animation: slideUp 0.3s; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="container">

    <div class="header-bar card" style="padding: 20px; margin:0;">
        <div style="display:flex; align-items:center; gap:15px;">
            <div style="background:var(--primary); color:white; padding:10px; border-radius:10px;">
                <i class="ph ph-graduation-cap" style="font-size: 2rem;"></i>
            </div>
            <div>
                <h2 style="margin:0;">KRU DREAM</h2>
                <small style="color:var(--text-light);">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏¢‡∏∏‡∏Ñ‡πÉ‡∏´‡∏°‡πà (V.7.0)</small>
            </div>
        </div>
        <div id="userProfileSection" class="hidden" style="text-align: right;">
            <div style="font-weight:bold; font-size:1.1rem;" id="userNameDisplay">Guest</div>
            <button onclick="logout()" class="btn btn-danger btn-sm" style="margin-top:5px; padding: 5px 12px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="viewLogin" class="login-container">
        <div class="card login-box">
            <h2 style="color:var(--text-dark);">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <p style="color:var(--text-light);">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
            
            <div class="login-input-group">
                <input type="text" id="smartInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20" onkeyup="checkInputType()">
            </div>

            <div id="adminPassArea" class="admin-secret">
                <input type="password" id="adminPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin (1234)" style="background:#fff7ed; border-color:#fdba74;">
            </div>

            <button onclick="performLogin()" class="btn btn-primary" style="width: 100%; justify-content: center; font-size: 1.2rem; padding: 15px;">
                üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            </button>
        </div>
    </div>

    <div id="viewStudent" class="hidden">
        <div id="studentMenu">
            <h3>üìö ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <div class="grid-lessons" id="lessonGrid"></div>
        </div>

        <div id="studentContent" class="hidden">
            <button onclick="backToMenu()" class="btn btn-outline" style="margin-bottom:15px;">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</button>
            <div class="card">
                <div class="header-bar" style="border:none; padding-bottom:0;">
                    <h2 id="contentTitle">Lesson Title</h2>
                    <div style="display:flex; gap:10px;">
                        <button onclick="showTab('read')" class="btn btn-primary">üìñ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</button>
                        <button onclick="showTab('quiz')" class="btn btn-outline">üìù ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
                    </div>
                </div>
                <hr style="border-top:1px solid #eee; margin:20px 0;">
                
                <div id="tabRead">
                    <div id="contentBody" style="min-height:200px; line-height:1.8;">Loading...</div>
                </div>
                
                <div id="tabQuiz" class="hidden">
                    <div id="quizContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="viewAdmin" class="hidden">
        <div class="admin-layout">
            <div class="sidebar card">
                <h4 style="margin-top:0; color:var(--text-light);">MENU</h4>
                <button onclick="switchAdminPage('students')" class="btn btn-outline active" id="btnMenuStd"><i class="ph ph-users"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button onclick="switchAdminPage('content')" class="btn btn-outline" id="btnMenuCon"><i class="ph ph-book-open"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</button>
            </div>

            <div class="card" style="min-height: 600px;">
                
                <div id="admPageStudents">
                    <div class="header-bar">
                        <h3>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <button onclick="openStudentModal()" class="btn btn-success"><i class="ph ph-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    <div style="margin-bottom: 15px; display:flex; gap:10px;">
                        <input type="text" id="searchBox" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." onkeyup="renderStudentTable()">
                    </div>
                    <div class="table-wrap">
                        <table id="studentTable">
                            <thead><tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏ä‡∏±‡πâ‡∏ô/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="studentTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admPageContent" class="hidden">
                    <div class="header-bar">
                        <h3>üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <button onclick="prepareNewLesson()" class="btn btn-success"><i class="ph ph-plus"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </div>
                    <div style="display:flex; gap:20px;">
                        <div style="flex:1; border-right:1px solid #eee; padding-right:10px;">
                            <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                            <div id="lessonList" style="max-height:500px; overflow-y:auto;"></div>
                        </div>
                        <div style="flex:2;">
                            <div id="editorArea" class="hidden">
                                <input type="hidden" id="editId">
                                <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="editTitle" style="margin-bottom:10px;">
                                <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Unit)</label>
                                <select id="editCategory" style="margin-bottom:10px;"></select>
                                <label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (HTML)</label>
                                <textarea id="editContent" style="height:150px; margin-bottom:10px; font-family:monospace;"></textarea>
                                
                                <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-top:10px;">
                                    <div style="display:flex; justify-content:space-between;">
                                        <h4 style="margin:0;">üß† ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (<span id="qCount">0</span> ‡∏Ç‡πâ‡∏≠)</h4>
                                        <button onclick="openQuizModal()" class="btn btn-sm btn-outline">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
                                    </div>
                                    <div id="quizListPreview" style="margin-top:10px;"></div>
                                </div>

                                <div style="margin-top:20px; display:flex; gap:10px;">
                                    <button onclick="saveLesson()" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                    <button onclick="deleteLesson()" class="btn btn-danger">‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á</button>
                                </div>
                            </div>
                            <div id="editorPlaceholder" style="text-align:center; padding:50px; color:#ccc;">
                                <i class="ph ph-arrow-left" style="font-size:2rem;"></i><br>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

<div id="studentModal" class="hidden modal-overlay">
    <div class="modal-box">
        <div class="header-bar"><h3>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3> <button onclick="closeModal('studentModal')" class="btn btn-sm">X</button></div>
        <input type="hidden" id="stdId">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (5 ‡∏´‡∏•‡∏±‡∏Å) <span style="color:red">*</span></label>
        <input type="text" id="stdCode" maxlength="5" placeholder="‡πÄ‡∏ä‡πà‡∏ô 66001">
        <label style="margin-top:10px; display:block;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="stdName">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <div><label>‡∏ä‡∏±‡πâ‡∏ô</label><input type="text" id="stdClass" placeholder="‡∏°.2/1"></div>
            <div><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label><input type="number" id="stdNumber"></div>
        </div>
        <button onclick="saveStudent()" class="btn btn-primary" style="width:100%; margin-top:20px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
</div>

<div id="quizModal" class="hidden modal-overlay">
    <div class="modal-box">
        <h3>‚úèÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h3>
        <textarea id="qText" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..." style="height:80px;"></textarea>
        <div style="margin:10px 0;">
            <button onclick="addOptionInput()" class="btn btn-sm btn-success">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            <span style="font-size:0.8rem; color:red;">*‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ï‡∏¥‡πä‡∏Å‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å</span>
        </div>
        <div id="optContainer"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="confirmQuiz()" class="btn btn-primary" style="flex:1;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            <button onclick="closeModal('quizModal')" class="btn btn-outline" style="flex:1;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const SUPABASE_URL = 'https://fddkpkcmkvitjkouxerg.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZGtwa2Nta3ZpdGprb3V4ZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDIxMjQsImV4cCI6MjA4MzAxODEyNH0.7OLB2igeXv3ZbLYQ2AJf-HxGpgyxqjwfAjrDG1rhP3E';
    
    let supabase;
    try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.error(e); }

    const UNITS = {
        'unit1': '1. ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', 'unit2': '2. ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', 'unit3': '3. ‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå',
        'unit4': '4. ‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'unit5': '5. ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏°‡∏Ø', 'unit6': '6. ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        'unit7': '7. ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏ô‡πÄ‡∏ô‡πá‡∏ï', 'unit8': '8. ‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡∏ï‡∏¥‡∏á'
    };

    // Global State
    let currentUser = null;
    let allStudents = [];
    let allLessons = [];
    let currentLessonData = null; // For student view
    let editingQuizData = []; // For admin editor
    let editingQuizIndex = -1;

    // --- 2. INITIALIZATION ---
    window.onload = () => {
        // Init Admin Select Options
        const sel = document.getElementById('editCategory');
        Object.keys(UNITS).forEach(k => sel.innerHTML += `<option value="${k}">${UNITS[k]}</option>`);
    };

    // --- 3. LOGIN SYSTEM ---
    function checkInputType() {
        const val = document.getElementById('smartInput').value;
        const adminArea = document.getElementById('adminPassArea');
        if (val.toLowerCase() === 'admin') {
            adminArea.classList.add('show');
        } else {
            adminArea.classList.remove('show');
            if(!'admin'.startsWith(val.toLowerCase())) document.getElementById('smartInput').value = val.replace(/[^0-9]/g, '').slice(0,5);
        }
    }

    async function performLogin() {
        const val = document.getElementById('smartInput').value.trim();
        
        // ADMIN LOGIN
        if (val.toLowerCase() === 'admin') {
            if (document.getElementById('adminPass').value === '1234') {
                currentUser = { role: 'admin', name: 'Administrator' };
                showView('viewAdmin');
                document.getElementById('userNameDisplay').innerText = "üîß Admin";
                document.getElementById('userProfileSection').classList.remove('hidden');
                switchAdminPage('students'); // Load default page
            } else { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
            return;
        }

        // STUDENT LOGIN
        if (val.length !== 5) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å');
        
        const { data, error } = await supabase.from('student_progress').select('*').eq('student_code', val).single();
        
        if (error || !data) {
            alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠');
        } else {
            currentUser = data;
            // Ensure array exists
            if(!currentUser.completed_lessons) currentUser.completed_lessons = [];
            
            // Update timestamp
            await supabase.from('student_progress').update({ last_login: new Date() }).eq('id', data.id);
            
            showView('viewStudent');
            document.getElementById('userNameDisplay').innerText = `üßí ${data.student_name}`;
            document.getElementById('userProfileSection').classList.remove('hidden');
            renderStudentMenu();
        }
    }

    function logout() { location.reload(); }
    
    function showView(viewId) {
        ['viewLogin', 'viewStudent', 'viewAdmin'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
    }

    // --- 4. STUDENT FEATURES ---
    function renderStudentMenu() {
        const grid = document.getElementById('lessonGrid');
        grid.innerHTML = '';
        Object.keys(UNITS).forEach((key, idx) => {
            grid.innerHTML += `
                <div class="card lesson-card" onclick="loadStudentLesson('${key}')" style="min-height:120px; padding:20px; position:relative;">
                    <div class="card-num">${idx+1}</div>
                    <h3 style="position:relative; z-index:1;">${UNITS[key]}</h3>
                    <span class="badge badge-green">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                </div>
            `;
        });
    }

    async function loadStudentLesson(key) {
        const { data } = await supabase.from('lessons').select('*').eq('category', key).single();
        if (!data) return alert('‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤');
        
        currentLessonData = data;
        document.getElementById('studentMenu').classList.add('hidden');
        document.getElementById('studentContent').classList.remove('hidden');
        document.getElementById('contentTitle').innerText = UNITS[key];
        showTab('read');
    }

    function showTab(tab) {
        if(tab === 'read') {
            document.getElementById('tabRead').classList.remove('hidden');
            document.getElementById('tabQuiz').classList.add('hidden');
            document.getElementById('contentBody').innerHTML = currentLessonData.content;
            
            // Auto Mark Complete
            if(currentUser && !currentUser.completed_lessons.includes(currentLessonData.id)) {
                currentUser.completed_lessons.push(currentLessonData.id);
                supabase.from('student_progress').update({ completed_lessons: currentUser.completed_lessons }).eq('id', currentUser.id).then();
            }
        } else {
            document.getElementById('tabRead').classList.add('hidden');
            document.getElementById('tabQuiz').classList.remove('hidden');
            renderStudentQuiz();
        }
    }

    function renderStudentQuiz() {
        const div = document.getElementById('quizContainer');
        div.innerHTML = '';
        if(!currentLessonData.quiz_data || currentLessonData.quiz_data.length === 0) {
            div.innerHTML = '<p class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>'; return;
        }
        
        currentLessonData.quiz_data.forEach((q, i) => {
            let opts = '';
            q.options.forEach((o, oi) => {
                opts += `<label style="display:block; margin:8px 0; cursor:pointer; background:#f8fafc; padding:10px; border-radius:8px;">
                            <input type="radio" name="q_${i}" value="${oi}"> ${o}
                         </label>`;
            });
            div.innerHTML += `<div style="margin-bottom:20px;">
                <h4 style="margin-bottom:10px;">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${i+1}: ${q.question}</h4>
                ${opts}
            </div>`;
        });
        div.innerHTML += `<button onclick="submitStudentQuiz()" class="btn btn-primary" style="width:100%;">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>`;
    }

    async function submitStudentQuiz() {
        if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö?')) return;
        let score = 0;
        currentLessonData.quiz_data.forEach((q, i) => {
            const sel = document.querySelector(`input[name="q_${i}"]:checked`);
            if(sel && parseInt(sel.value) === parseInt(q.correct)) score++;
        });
        
        alert(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${score} / ${currentLessonData.quiz_data.length}`);
        
        await supabase.from('quiz_results').insert([{
            student_id: currentUser.id,
            lesson_id: currentLessonData.id,
            score: score,
            total_score: currentLessonData.quiz_data.length,
            passed: (score / currentLessonData.quiz_data.length) >= 0.5
        }]);
        
        backToMenu();
    }

    function backToMenu() {
        document.getElementById('studentContent').classList.add('hidden');
        document.getElementById('studentMenu').classList.remove('hidden');
    }

    // --- 5. ADMIN: STUDENTS ---
    function switchAdminPage(page) {
        document.getElementById('admPageStudents').classList.toggle('hidden', page !== 'students');
        document.getElementById('admPageContent').classList.toggle('hidden', page !== 'content');
        
        document.getElementById('btnMenuStd').classList.toggle('active', page === 'students');
        document.getElementById('btnMenuCon').classList.toggle('active', page === 'content');

        if(page === 'students') fetchStudents();
        if(page === 'content') fetchLessons();
    }

    async function fetchStudents() {
        const { data, error } = await supabase.from('student_progress').select('*').order('student_code');
        if(error) return alert('Error: ' + error.message);
        allStudents = data;
        renderStudentTable();
    }

    function renderStudentTable() {
        const filter = document.getElementById('searchBox').value.toLowerCase();
        const tbody = document.getElementById('studentTableBody');
        tbody.innerHTML = '';
        
        allStudents.forEach(s => {
            if(s.student_name.toLowerCase().includes(filter) || s.student_code.includes(filter)) {
                const isOnline = s.last_login && (new Date() - new Date(s.last_login) < 5 * 60 * 1000);
                tbody.innerHTML += `
                    <tr>
                        <td>${isOnline ? '<span class="badge badge-green">Online</span>' : '<span class="badge badge-gray">Offline</span>'}</td>
                        <td style="font-weight:bold; color:var(--primary);">${s.student_code}</td>
                        <td>${s.student_name}</td>
                        <td>${s.student_class} (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${s.student_number})</td>
                        <td>
                            <button onclick='editStudent(${JSON.stringify(s)})' class="btn btn-sm btn-outline">‚úèÔ∏è</button>
                            <button onclick="deleteStudent(${s.id})" class="btn btn-sm btn-danger">üóë</button>
                        </td>
                    </tr>
                `;
            }
        });
        if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="5" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    }

    // Student CRUD
    function openStudentModal() {
        document.getElementById('stdId').value = '';
        document.getElementById('stdCode').value = '';
        document.getElementById('stdName').value = '';
        document.getElementById('stdClass').value = '';
        document.getElementById('stdNumber').value = '';
        document.getElementById('studentModal').classList.remove('hidden');
    }

    function editStudent(s) {
        document.getElementById('stdId').value = s.id;
        document.getElementById('stdCode').value = s.student_code;
        document.getElementById('stdName').value = s.student_name;
        document.getElementById('stdClass').value = s.student_class;
        document.getElementById('stdNumber').value = s.student_number;
        document.getElementById('studentModal').classList.remove('hidden');
    }

    async function saveStudent() {
        const id = document.getElementById('stdId').value;
        const payload = {
            student_code: document.getElementById('stdCode').value,
            student_name: document.getElementById('stdName').value,
            student_class: document.getElementById('stdClass').value,
            student_number: document.getElementById('stdNumber').value
        };

        if(payload.student_code.length !== 5) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 5 ‡∏´‡∏•‡∏±‡∏Å");
        if(!payload.student_name) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");

        let err;
        if(id) {
            const { error } = await supabase.from('student_progress').update(payload).eq('id', id);
            err = error;
        } else {
            const { error } = await supabase.from('student_progress').insert([{...payload, study_time:{}, completed_lessons:[]}]);
            err = error;
        }

        if(err) alert(err.message);
        else { closeModal('studentModal'); fetchStudents(); }
    }

    async function deleteStudent(id) {
        if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?')) {
            await supabase.from('student_progress').delete().eq('id', id);
            fetchStudents();
        }
    }

    // --- 6. ADMIN: CONTENT ---
    async function fetchLessons() {
        const { data } = await supabase.from('lessons').select('*').order('category');
        allLessons = data || [];
        renderLessonList();
    }

    function renderLessonList() {
        const div = document.getElementById('lessonList');
        div.innerHTML = '';
        allLessons.forEach(l => {
            div.innerHTML += `
                <div class="card lesson-item" onclick="loadEditor(${l.id})" style="padding:15px; margin-bottom:10px; cursor:pointer; border:1px solid #eee;">
                    <b>${l.category}</b><br>${l.title}
                </div>
            `;
        });
    }

    function prepareNewLesson() {
        document.getElementById('editorPlaceholder').classList.add('hidden');
        document.getElementById('editorArea').classList.remove('hidden');
        
        document.getElementById('editId').value = '';
        document.getElementById('editTitle').value = '';
        document.getElementById('editContent').value = '';
        editingQuizData = [];
        renderQuizPreview();
    }

    function loadEditor(id) {
        const l = allLessons.find(x => x.id == id);
        document.getElementById('editorPlaceholder').classList.add('hidden');
        document.getElementById('editorArea').classList.remove('hidden');

        document.getElementById('editId').value = l.id;
        document.getElementById('editTitle').value = l.title;
        document.getElementById('editCategory').value = l.category;
        document.getElementById('editContent').value = l.content;
        editingQuizData = l.quiz_data || [];
        renderQuizPreview();
    }

    function renderQuizPreview() {
        const div = document.getElementById('quizListPreview');
        div.innerHTML = '';
        document.getElementById('qCount').innerText = editingQuizData.length;
        
        editingQuizData.forEach((q, i) => {
            div.innerHTML += `
                <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:6px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${i+1}.</b> ${q.question}</div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="editQuiz(${i})" class="btn-sm btn-outline">‡πÅ‡∏Å‡πâ</button>
                        <button onclick="deleteQuiz(${i})" class="btn-sm btn-danger">‡∏•‡∏ö</button>
                    </div>
                </div>
            `;
        });
    }

    // Quiz Builder Logic
    function openQuizModal() {
        editingQuizIndex = -1;
        document.getElementById('qText').value = '';
        document.getElementById('optContainer').innerHTML = '';
        addOptionInput(); addOptionInput(); // 2 defaults
        document.getElementById('quizModal').classList.remove('hidden');
    }

    function addOptionInput(val='', isCorrect=false) {
        const div = document.createElement('div');
        div.className = 'quiz-opt-row';
        div.style.display = 'flex'; div.style.gap = '10px'; div.style.marginBottom = '5px';
        div.innerHTML = `
            <input type="radio" name="correct" style="width:20px;" ${isCorrect?'checked':''}>
            <input type="text" class="q-opt-val" value="${val}" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...">
            <button onclick="this.parentElement.remove()" style="border:none; background:none; cursor:pointer;">‚ùå</button>
        `;
        document.getElementById('optContainer').appendChild(div);
    }

    function confirmQuiz() {
        const q = document.getElementById('qText').value;
        const opts = []; let correct = -1;
        
        document.querySelectorAll('.quiz-opt-row').forEach((row, i) => {
            const txt = row.querySelector('.q-opt-val').value;
            opts.push(txt);
            if(row.querySelector('input[name="correct"]').checked) correct = i;
        });

        if(correct === -1) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å');
        
        const obj = { question: q, options: opts, correct: correct };
        
        if(editingQuizIndex === -1) editingQuizData.push(obj);
        else editingQuizData[editingQuizIndex] = obj;
        
        closeModal('quizModal');
        renderQuizPreview();
    }

    function editQuiz(i) {
        editingQuizIndex = i;
        const d = editingQuizData[i];
        document.getElementById('qText').value = d.question;
        document.getElementById('optContainer').innerHTML = '';
        d.options.forEach((o, idx) => addOptionInput(o, idx===parseInt(d.correct)));
        document.getElementById('quizModal').classList.remove('hidden');
    }

    function deleteQuiz(i) {
        editingQuizData.splice(i, 1);
        renderQuizPreview();
    }

    async function saveLesson() {
        const id = document.getElementById('editId').value;
        const payload = {
            title: document.getElementById('editTitle').value,
            category: document.getElementById('editCategory').value,
            content: document.getElementById('editContent').value,
            quiz_data: editingQuizData
        };

        const { error } = id ? await supabase.from('lessons').update(payload).eq('id', id)
                             : await supabase.from('lessons').insert([payload]);
        
        if(error) alert(error.message);
        else { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); fetchLessons(); }
    }

    async function deleteLesson() {
        const id = document.getElementById('editId').value;
        if(id && confirm('‡∏•‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ?')) {
            await supabase.from('lessons').delete().eq('id', id);
            fetchLessons();
            document.getElementById('editorArea').classList.add('hidden');
            document.getElementById('editorPlaceholder').classList.remove('hidden');
        }
    }

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

</script>
</body>
</html>
