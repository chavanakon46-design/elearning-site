<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏•‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏¥‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå (V.4 Quiz & Stats)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô --- */
        :root {
            --primary: #2563eb; 
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }

        /* Layout */
        .container { max-width: 1100px; margin: 0 auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-height: 85vh; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 120px; font-family: monospace; }
        
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: 0.2s; text-align: center; width: 100%; margin-bottom: 5px;}
        .btn-sm { padding: 5px 10px; font-size: 0.9rem; width: auto; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--text-main); }
        .btn-outline:hover { background: #eff6ff; border-color: var(--primary); color: var(--primary); }
        
        /* Utilities */
        .hidden { display: none !important; }
        .flex-gap { display: flex; gap: 10px; flex-wrap: wrap; }
        .badge { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; }
        .badge-time { background: #e0f2fe; color: #075985; padding: 4px 10px; border-radius: 12px; font-weight: bold; }

        /* Menu Grid (8 Topics) */
        .grid-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .menu-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; cursor: pointer; background: #fff; transition: 0.2s; position: relative; overflow: hidden; }
        .menu-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
        .topic-number { font-size: 3rem; font-weight: 900; color: #f3f4f6; position: absolute; right: -10px; top: -10px; z-index: 0; }
        .topic-content { position: relative; z-index: 1; }

        /* Lesson & Quiz Viewer */
        .lesson-viewer { background: #f8fafc; padding: 25px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .quiz-container { background: white; padding: 20px; border-radius: 8px; border: 1px solid #cbd5e1; margin-top: 20px; }
        .question-box { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .option-label { display: block; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin-top: 5px; cursor: pointer; transition: 0.2s; }
        .option-label:hover { background: #f1f5f9; }
        .option-label input { width: auto; margin-right: 10px; }

        /* Admin & Profile Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .data-table th, .data-table td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
        .data-table th { background: #f3f4f6; font-weight: 600; }
        
        /* Tabs */
        .tab-group { border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; display: flex; gap: 20px; }
        .tab-btn { padding: 10px 0; cursor: pointer; color: #6b7280; border-bottom: 3px solid transparent; font-weight: 600; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    
    <header class="header">
        <div>
            <h1 style="margin:0; color: var(--primary);">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</h1>
            <small style="color: #6b7280;">Computer Science E-Learning System V.4</small>
        </div>
        <div id="userInfo" class="hidden text-right">
            <div style="margin-bottom: 5px;">
                <span id="userDisplay" style="font-weight: bold; font-size: 1.1rem;"></span>
            </div>
            <div class="flex-gap" style="justify-content: flex-end; align-items: center;">
                <div id="timerDisplay" class="badge-time hidden">‚è± 00:00</div>
                <button onclick="openProfile()" class="btn btn-sm btn-outline" style="margin:0;">üë§ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
                <button onclick="logout()" class="btn btn-sm btn-danger" style="margin:0;">‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>
    </header>

    <div id="loginSection" class="text-center" style="padding: 60px 0;">
        <h2 style="color: var(--text-main);">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
        <div style="max-width: 350px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; border: 1px solid #e5e7eb;">
            <input type="text" id="stdName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå admin)">
            <input type="text" id="stdClass" placeholder="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏°.2/1)">
            <input type="number" id="stdNumber" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà (Password)">
            <button onclick="handleLogin()" class="btn btn-primary" style="margin-top: 15px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="studentDashboard" class="hidden">
        
        <div id="mainMenu">
            <h3 style="margin-bottom: 20px;">üìö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <div class="grid-menu" id="topicGrid">
                </div>
        </div>

        <div id="contentArea" class="hidden">
            <div class="header" style="border:none; padding-bottom:0; margin-bottom: 10px;">
                <h2 id="lessonTitle" style="margin:0;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <button onclick="backToDash()" class="btn btn-outline btn-sm">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            </div>

            <div class="tab-group">
                <div class="tab-btn active" onclick="switchContentTab('learn')">üìñ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                <div class="tab-btn" onclick="switchContentTab('quiz')">üìù ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
            </div>

            <div id="view-learn">
                <div id="lessonViewer" class="lesson-viewer">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>

            <div id="view-quiz" class="hidden">
                <div id="quizArea" class="quiz-container">
                    </div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; width:90%; max-width:800px; padding:25px; border-radius:10px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <button onclick="closeProfile()" class="btn btn-sm btn-danger">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin: 20px 0;">
                <div style="background:#f0f9ff; padding:15px; border-radius:8px;">
                    <h3>‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <h1 id="profileTotalTime" style="color:var(--primary); margin:0;">0 ‡∏ô‡∏≤‡∏ó‡∏µ</h1>
                </div>
                <div style="background:#ecfdf5; padding:15px; border-radius:8px;">
                    <h3>‚úÖ ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h3>
                    <h1 id="profileCompletedCount" style="color:var(--success); margin:0;">0 ‡∏ö‡∏ó</h1>
                </div>
            </div>

            <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Real-time)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö</th>
                        <th>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                        <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                        <th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
                    </tr>
                </thead>
                <tbody id="profileQuizTable"></tbody>
            </table>
        </div>
    </div>

    <div id="adminDashboard" class="hidden">
        <div style="background:#fff7ed; padding:15px; border-radius:8px; border:1px solid #fdba74; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:#9a3412;">üîß ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h3>
            <button onclick="logout()" class="btn btn-danger btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin</button>
        </div>

        <div class="tab-group">
            <div class="tab-btn active" onclick="switchAdminTab('content')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ & ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>
            <div class="tab-btn" onclick="switchAdminTab('monitor')">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        </div>

        <div id="admin-tab-content" style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 280px;">
                <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h4>
                <div id="adminLessonList" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; background:white;"></div>
                <button onclick="prepareNewLesson()" class="btn btn-success" style="margin-top: 10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            
            <div style="flex: 2; min-width: 350px;">
                <div style="background:white; padding:20px; border:1px solid #ddd; border-radius:8px;">
                    <h4 style="margin-top:0;">üìù Editor</h4>
                    
                    <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
                    <input type="text" id="editTitle">
                    
                    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Unit):</label>
                    <select id="editCategory"></select>

                    <label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (HTML / Embed Code):</label>
                    <textarea id="editContent" placeholder="<p>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤...</p>"></textarea>

                    <hr style="margin: 20px 0;">
                    
                    <h4>üß† ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Quiz Builder)</h4>
                    <div id="quizBuilderArea" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:15px;">
                        <div id="qList"></div>
                        <button onclick="addQuestionUI()" class="btn btn-sm btn-outline" style="margin-top:10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</button>
                    </div>

                    <input type="hidden" id="editId">
                    <div class="flex-gap">
                        <button onclick="saveLessonToDB()" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="deleteLesson()" class="btn btn-danger" style="width: auto;">‡∏•‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-tab-monitor" class="hidden">
            <button onclick="fetchStudentMonitor()" class="btn btn-outline btn-sm" style="margin-bottom:10px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏ä‡∏±‡πâ‡∏ô/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö (‡∏ö‡∏ó)</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏° (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                            <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                        </tr>
                    </thead>
                    <tbody id="monitorTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    // --- Config ---
    // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const SUPABASE_URL = 'https://fddkpkcmkvitjkouxerg.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZGtwa2Nta3ZpdGprb3V4ZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDIxMjQsImV4cCI6MjA4MzAxODEyNH0.7OLB2igeXv3ZbLYQ2AJf-HxGpgyxqjwfAjrDG1rhP3E';

    // 8 ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠
    const UNITS = {
        'unit1': '1. ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
        'unit2': '2. ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
        'unit3': '3. ‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå',
        'unit4': '4. ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£',
        'unit5': '5. ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        'unit6': '6. ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
        'unit7': '7. ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏ô‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        'unit8': '8. ‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡∏ï‡∏¥‡∏á'
    };

    let dbClient;
    try {
        dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) { console.error("DB Error", e); }

    // --- State Variables ---
    let currentUser = null;
    let currentLesson = null; // Object
    let studyTimer = null;
    let secondsSpent = 0;
    let editingQuizData = []; // Buffer for Admin Quiz Editor

    // --- Initialization ---
    window.onload = function() {
        initTopicGrid();
        initAdminSelect();
    };

    function initTopicGrid() {
        const grid = document.getElementById('topicGrid');
        grid.innerHTML = '';
        Object.keys(UNITS).forEach((key, index) => {
            const div = document.createElement('div');
            div.className = 'menu-card';
            div.onclick = () => loadLessonGroup(key);
            div.innerHTML = `
                <div class="topic-number">${index + 1}</div>
                <div class="topic-content">
                    <h3 style="margin-top:0; color:var(--primary);">${UNITS[key]}</h3>
                    <small style="color:#6b7280;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</small>
                </div>
            `;
            grid.appendChild(div);
        });
    }

    function initAdminSelect() {
        const sel = document.getElementById('editCategory');
        sel.innerHTML = '';
        Object.keys(UNITS).forEach(key => {
            const opt = document.createElement('option');
            opt.value = key;
            opt.innerText = UNITS[key];
            sel.appendChild(opt);
        });
    }

    // --- Login System ---
    async function handleLogin() {
        if (!dbClient) return alert("Connection Error");
        const name = document.getElementById('stdName').value.trim();
        const sClass = document.getElementById('stdClass').value.trim();
        const code = document.getElementById('stdNumber').value.trim();

        if (!name || !code) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        // Admin Check
        if (name.toLowerCase() === 'admin' && code === '1234') {
            currentUser = { role: 'admin', name: 'Administrator' };
            switchPage('adminDashboard');
            fetchLessonsForAdmin();
            fetchStudentMonitor();
            return;
        }

        // Student Login/Register
        let { data: user, error } = await dbClient.from('student_progress')
            .select('*').eq('student_name', name).eq('student_number', code).single();

        if (!user) {
            // New Student
            const { data: newUser, error: err } = await dbClient.from('student_progress')
                .insert([{ 
                    student_name: name, 
                    student_class: sClass, 
                    student_number: code,
                    study_time: {},
                    completed_lessons: []
                }]).select().single();
            if (err) return alert("Login Failed: " + err.message);
            user = newUser;
        } else {
            // Update timestamp
            await dbClient.from('student_progress').update({ last_login: new Date() }).eq('id', user.id);
        }

        currentUser = user;
        if(!currentUser.study_time) currentUser.study_time = {};
        if(!currentUser.completed_lessons) currentUser.completed_lessons = [];

        document.getElementById('userDisplay').innerText = `‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${currentUser.student_name}`;
        document.getElementById('userInfo').classList.remove('hidden');
        switchPage('studentDashboard');
    }

    function logout() {
        stopLessonTimer();
        location.reload();
    }

    function switchPage(pageId) {
        ['loginSection', 'studentDashboard', 'adminDashboard'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
    }

    // --- Student Logic ---
    async function loadLessonGroup(categoryKey) {
        // Fetch lesson specific to this Unit
        const { data } = await dbClient.from('lessons').select('*').eq('category', categoryKey).limit(1).single();
        
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô Unit ‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Dummy
        if (!data) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ");

        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('contentArea').classList.remove('hidden');
        
        currentLesson = data;
        document.getElementById('lessonTitle').innerText = UNITS[categoryKey] || currentLesson.title;
        
        // Default Tab
        switchContentTab('learn');
    }

    function switchContentTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        if (tab === 'learn') {
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.getElementById('view-learn').classList.remove('hidden');
            document.getElementById('view-quiz').classList.add('hidden');
            renderLessonContent();
        } else {
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.getElementById('view-learn').classList.add('hidden');
            document.getElementById('view-quiz').classList.remove('hidden');
            stopLessonTimer(); // Stop study timer when doing quiz
            renderQuiz();
        }
    }

    function renderLessonContent() {
        document.getElementById('lessonViewer').innerHTML = currentLesson.content;
        
        // Start Timer
        stopLessonTimer();
        secondsSpent = 0;
        document.getElementById('timerDisplay').classList.remove('hidden');
        studyTimer = setInterval(() => {
            secondsSpent++;
            const mins = Math.floor(secondsSpent / 60).toString().padStart(2, '0');
            const secs = (secondsSpent % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').innerText = `‚è± ${mins}:${secs}`;
        }, 1000);

        // Mark complete logic can be added here (e.g., must stay for 30s)
        if(!currentUser.completed_lessons.includes(currentLesson.id)) {
             // Simple marking: opened = learned (can be improved)
             currentUser.completed_lessons.push(currentLesson.id);
             dbClient.from('student_progress').update({
                 completed_lessons: currentUser.completed_lessons
             }).eq('id', currentUser.id).then(()=>{});
        }
    }

    async function stopLessonTimer() {
        if (currentLesson && studyTimer) {
            clearInterval(studyTimer);
            document.getElementById('timerDisplay').classList.add('hidden');
            
            const existingTime = currentUser.study_time[currentLesson.category] || 0; // Use Category as key for Unit Time
            const newTotal = existingTime + secondsSpent;
            currentUser.study_time[currentLesson.category] = newTotal;

            await dbClient.from('student_progress').update({ 
                study_time: currentUser.study_time
            }).eq('id', currentUser.id);

            secondsSpent = 0;
            studyTimer = null;
        }
    }

    function backToDash() {
        stopLessonTimer();
        document.getElementById('contentArea').classList.add('hidden');
        document.getElementById('mainMenu').classList.remove('hidden');
        currentLesson = null;
    }

    // --- Quiz Logic (Student) ---
    function renderQuiz() {
        const container = document.getElementById('quizArea');
        container.innerHTML = '';

        if (!currentLesson.quiz_data || currentLesson.quiz_data.length === 0) {
            container.innerHTML = '<p class="text-center text-sub">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</p>';
            return;
        }

        container.innerHTML = '<h3>üìù ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ' + (UNITS[currentLesson.category] || '') + '</h3>';

        currentLesson.quiz_data.forEach((q, idx) => {
            const box = document.createElement('div');
            box.className = 'question-box';
            let optionsHTML = '';
            
            q.options.forEach((opt, optIdx) => {
                optionsHTML += `
                    <label class="option-label">
                        <input type="radio" name="q_${idx}" value="${optIdx}"> ${opt}
                    </label>
                `;
            });

            box.innerHTML = `
                <p><b>‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${idx + 1}:</b> ${q.question}</p>
                <div>${optionsHTML}</div>
            `;
            container.appendChild(box);
        });

        const btn = document.createElement('button');
        btn.className = 'btn btn-primary';
        btn.innerText = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö';
        btn.onclick = calculateScore;
        container.appendChild(btn);
    }

    async function calculateScore() {
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö?")) return;

        let score = 0;
        const total = currentLesson.quiz_data.length;
        const answers = currentLesson.quiz_data;

        // Check answers
        answers.forEach((q, idx) => {
            const selected = document.querySelector(`input[name="q_${idx}"]:checked`);
            if (selected && parseInt(selected.value) === parseInt(q.correct)) {
                score++;
            }
        });

        // Show Result
        alert(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${score} / ${total}`);

        // Save to DB
        const passed = (score / total) >= 0.5; // Pass if >= 50%
        await dbClient.from('quiz_results').insert([{
            student_id: currentUser.id,
            lesson_id: currentLesson.id,
            score: score,
            total_score: total,
            passed: passed
        }]);

        // Refresh Quiz UI (Optional: show correct answers or lock)
        backToDash();
    }

    // --- Profile Logic ---
    async function openProfile() {
        // Calculate Total Time
        let totalSec = 0;
        if(currentUser.study_time) {
            Object.values(currentUser.study_time).forEach(v => totalSec += v);
        }
        document.getElementById('profileTotalTime').innerText = Math.floor(totalSec/60) + " ‡∏ô‡∏≤‡∏ó‡∏µ";
        document.getElementById('profileCompletedCount').innerText = currentUser.completed_lessons.length + " ‡∏ö‡∏ó";

        // Fetch Quiz History
        const { data: history } = await dbClient.from('quiz_results')
            .select(`*, lessons(title, category)`)
            .eq('student_id', currentUser.id)
            .order('created_at', { ascending: false });

        const tbody = document.getElementById('profileQuizTable');
        tbody.innerHTML = '';
        if(history) {
            history.forEach(h => {
                const tr = document.createElement('tr');
                const date = new Date(h.created_at).toLocaleString('th-TH');
                const lessonName = h.lessons ? (UNITS[h.lessons.category] || h.lessons.title) : 'Unknown';
                tr.innerHTML = `
                    <td>${date}</td>
                    <td>${lessonName}</td>
                    <td>${h.score} / ${h.total_score}</td>
                    <td>${h.passed ? '<span style="color:green">‡∏ú‡πà‡∏≤‡∏ô</span>' : '<span style="color:red">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</span>'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('profileModal').classList.remove('hidden');
    }

    function closeProfile() {
        document.getElementById('profileModal').classList.add('hidden');
    }

    // --- Admin Logic ---
    function switchAdminTab(tab) {
        document.querySelectorAll('#adminDashboard .tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if(tab === 'content') {
            document.getElementById('admin-tab-content').classList.remove('hidden');
            document.getElementById('admin-tab-monitor').classList.add('hidden');
        } else {
            document.getElementById('admin-tab-content').classList.add('hidden');
            document.getElementById('admin-tab-monitor').classList.remove('hidden');
            fetchStudentMonitor();
        }
    }

    async function fetchLessonsForAdmin() {
        const { data } = await dbClient.from('lessons').select('*').order('category');
        const list = document.getElementById('adminLessonList');
        list.innerHTML = '';
        data.forEach(l => {
            const item = document.createElement('div');
            item.style.padding = '10px';
            item.style.borderBottom = '1px solid #eee';
            item.style.cursor = 'pointer';
            item.innerHTML = `<b>${l.category}</b>: ${l.title}`;
            item.onclick = () => loadAdminEditor(l);
            list.appendChild(item);
        });
    }

    function prepareNewLesson() {
        document.getElementById('editId').value = '';
        document.getElementById('editTitle').value = '';
        document.getElementById('editContent').value = '';
        editingQuizData = [];
        renderAdminQuizBuilder();
    }

    function loadAdminEditor(l) {
        document.getElementById('editId').value = l.id;
        document.getElementById('editTitle').value = l.title;
        document.getElementById('editCategory').value = l.category;
        document.getElementById('editContent').value = l.content;
        editingQuizData = l.quiz_data || [];
        renderAdminQuizBuilder();
    }

    // --- Admin Quiz Builder ---
    function renderAdminQuizBuilder() {
        const div = document.getElementById('qList');
        div.innerHTML = '';
        editingQuizData.forEach((q, idx) => {
            const qDiv = document.createElement('div');
            qDiv.style.background = 'white';
            qDiv.style.padding = '10px';
            qDiv.style.marginBottom = '10px';
            qDiv.style.border = '1px solid #ddd';
            qDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <b>Q${idx+1}: ${q.question}</b>
                    <button onclick="removeQuestion(${idx})" style="color:red; border:none; background:none;">‡∏•‡∏ö</button>
                </div>
                <small>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${q.options.join(', ')} (‡πÄ‡∏â‡∏•‡∏¢: ‡∏Ç‡πâ‡∏≠ ${parseInt(q.correct)+1})</small>
            `;
            div.appendChild(qDiv);
        });
    }

    function addQuestionUI() {
        const qText = prompt("‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:");
        if(!qText) return;
        
        // Simple Input for options: comma separated
        const optsStr = prompt("‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ , ):\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÉ‡∏ä‡πà, ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà");
        if(!optsStr) return;
        const opts = optsStr.split(',').map(s => s.trim());

        const correct = prompt(`‡πÄ‡∏â‡∏•‡∏¢‡∏Ç‡πâ‡∏≠‡πÑ‡∏´‡∏ô? (‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0 ‡∏ñ‡∏∂‡∏á ${opts.length-1})`);
        if(correct === null || isNaN(correct)) return;

        editingQuizData.push({
            question: qText,
            options: opts,
            correct: parseInt(correct)
        });
        renderAdminQuizBuilder();
    }

    function removeQuestion(idx) {
        editingQuizData.splice(idx, 1);
        renderAdminQuizBuilder();
    }

    async function saveLessonToDB() {
        const id = document.getElementById('editId').value;
        const title = document.getElementById('editTitle').value;
        const category = document.getElementById('editCategory').value;
        const content = document.getElementById('editContent').value;
        
        if (!title) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠");

        const payload = {
            title, category, content, 
            quiz_data: editingQuizData
        };

        let err;
        if(id) {
            const { error } = await dbClient.from('lessons').update(payload).eq('id', id);
            err = error;
        } else {
            const { error } = await dbClient.from('lessons').insert([payload]);
            err = error;
        }

        if(err) alert("Error: " + err.message);
        else {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            fetchLessonsForAdmin();
        }
    }

    async function deleteLesson() {
        const id = document.getElementById('editId').value;
        if(!id || !confirm("‡∏•‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
        await dbClient.from('lessons').delete().eq('id', id);
        fetchLessonsForAdmin();
        prepareNewLesson();
    }

    // --- Admin Monitor ---
    async function fetchStudentMonitor() {
        const { data: students } = await dbClient.from('student_progress').select('*').order('last_login', {ascending:false});
        const tbody = document.getElementById('monitorTableBody');
        tbody.innerHTML = '';
        if(students) {
            students.forEach(s => {
                let totalSec = 0;
                if(s.study_time) Object.values(s.study_time).forEach(v => totalSec+=v);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date() - new Date(s.last_login) < 300000 ? 'üü¢ Online' : '‚ö™ Offline'}</td>
                    <td>${s.student_name}</td>
                    <td>${s.student_class} #${s.student_number}</td>
                    <td>${s.completed_lessons ? s.completed_lessons.length : 0}</td>
                    <td>${Math.floor(totalSec/60)}</td>
                    <td>${new Date(s.last_login).toLocaleString('th-TH')}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

</script>
</body>
</html>