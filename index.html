<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏•‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏¥‡∏á KRU DREAM (V.5.1 Student ID)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô --- */
        :root {
            --primary: #2563eb; 
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --info: #06b6d4;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }

        /* Layout */
        .container { max-width: 1280px; margin: 0 auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-height: 85vh; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 120px; font-family: monospace; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; transition: 0.2s; gap: 5px; }
        .btn-sm { padding: 4px 10px; font-size: 0.85rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--text-main); }
        .btn-outline:hover { background: #eff6ff; border-color: var(--primary); color: var(--primary); }
        
        /* Utilities */
        .hidden { display: none !important; }
        .flex-gap { display: flex; gap: 10px; flex-wrap: wrap; }
        .badge { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; }
        .badge-time { background: #e0f2fe; color: #075985; padding: 4px 10px; border-radius: 12px; font-weight: bold; }
        .w-full { width: 100%; }

        /* Dashboard Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; border: 1px solid #e5e7eb; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .stat-label { color: #6b7280; font-size: 0.9rem; }

        /* Progress Bar */
        .progress-container { width: 100%; background-color: #e5e7eb; border-radius: 10px; height: 10px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; background-color: var(--success); width: 0%; transition: width 0.5s; }

        /* Tables & Lists */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .data-table th, .data-table td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
        .data-table th { background: #f9fafb; font-weight: 600; color: #374151; }
        .status-pass { color: #166534; background: #dcfce7; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .status-fail { color: #991b1b; background: #fee2e2; padding: 2px 6px; border-radius: 4px; font-weight: bold; }

        /* Menu Grid */
        .grid-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .menu-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; cursor: pointer; background: #fff; transition: 0.2s; position: relative; overflow: hidden; }
        .menu-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
        .topic-number { font-size: 3rem; font-weight: 900; color: #f3f4f6; position: absolute; right: -10px; top: -10px; z-index: 0; }
        .topic-content { position: relative; z-index: 1; }

        /* Admin Tabs */
        .tab-group { border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; display: flex; gap: 20px; overflow-x: auto; }
        .tab-btn { padding: 10px 15px; cursor: pointer; color: #6b7280; border-bottom: 3px solid transparent; font-weight: 600; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #eff6ff; border-radius: 5px 5px 0 0; }

        /* Quiz Editor */
        .quiz-editor-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; }
        .quiz-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .opt-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: #f8fafc; padding: 8px; border-radius: 6px; border: 1px solid #f1f5f9; }

        /* Modal */
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; display:flex; justify-content:center; align-items:center; }
        .modal-box { background:white; width:95%; max-width:1000px; padding:25px; border-radius:10px; max-height:90vh; overflow-y:auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px; }

        /* Lesson Viewer in Admin */
        .preview-box { border: 2px dashed #cbd5e1; padding: 20px; background: #f8fafc; border-radius: 8px; margin-top: 20px; min-height: 200px; }
    </style>
</head>
<body>

<div class="container">
    
    <header class="header">
        <div>
            <h1 style="margin:0; color: var(--primary);">KRU DREAM E-LEARNING</h1>
            <small style="color: #6b7280;">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏™‡∏±‡∏°‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (V.5.1)</small>
        </div>
        <div id="userInfo" class="hidden text-right">
            <div style="margin-bottom: 5px;">
                <span id="userDisplay" style="font-weight: bold; font-size: 1.1rem;"></span>
            </div>
            <div class="flex-gap" style="justify-content: flex-end; align-items: center;">
                <div id="timerDisplay" class="badge-time hidden">‚è± 00:00</div>
                <button onclick="openProfile()" class="btn btn-sm btn-outline">üë§ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                <button onclick="logout()" class="btn btn-sm btn-danger">‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>
    </header>

    <div id="loginSection" class="text-center" style="padding: 60px 0;">
        <h2 style="color: var(--text-main);">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <div style="max-width: 350px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
            <div style="text-align: left; margin-bottom: 5px; font-weight: bold;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
            <input type="text" id="stdName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î.‡∏ä.‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Ç‡∏¢‡∏±‡∏ô‡∏¢‡∏¥‡πà‡∏á">
            
            <div style="text-align: left; margin-bottom: 5px; font-weight: bold; margin-top: 10px;">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (5 ‡∏´‡∏•‡∏±‡∏Å)</div>
            <input type="number" id="stdCodeInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô 66001 (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô)" maxlength="5" oninput="if(this.value.length > 5) this.value = this.value.slice(0, 5);">
            
            <button onclick="handleLogin()" class="btn btn-primary w-full" style="margin-top: 20px; font-size: 1.1rem; padding: 12px;">üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p style="margin-top: 15px; font-size: 0.85rem; color: #9ca3af;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
        </div>
    </div>

    <div id="studentDashboard" class="hidden">
        <div id="mainMenu">
            <h3 style="margin-bottom: 20px;">üìö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <div class="grid-menu" id="topicGrid"></div>
        </div>

        <div id="contentArea" class="hidden">
            <div class="header" style="border:none; padding-bottom:0; margin-bottom: 10px;">
                <h2 id="lessonTitle" style="margin:0;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <button onclick="backToDash()" class="btn btn-outline btn-sm">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            </div>

            <div class="tab-group">
                <div class="tab-btn active" onclick="switchContentTab('learn')">üìñ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                <div class="tab-btn" onclick="switchContentTab('quiz')">üìù ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
            </div>

            <div id="view-learn">
                <div id="lessonViewer" class="preview-box" style="border-style: solid; background: #fff;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            <div id="view-quiz" class="hidden">
                <div id="quizArea" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #cbd5e1; margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <div id="adminDashboard" class="hidden">
        <div style="background:#fff7ed; padding:15px; border-radius:8px; border:1px solid #fdba74; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:#9a3412;">üîß ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h3>
            <button onclick="logout()" class="btn btn-danger btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin</button>
        </div>

        <div class="tab-group">
            <div class="tab-btn active" onclick="switchAdminTab('students')">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
            <div class="tab-btn" onclick="switchAdminTab('stats')">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
            <div class="tab-btn" onclick="switchAdminTab('content')">üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</div>
            <div class="tab-btn" onclick="switchAdminTab('monitor')">üëÄ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
        </div>

        <div id="admin-tab-students" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                <button onclick="openStudentModal()" class="btn btn-success">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <div style="background: #e0f2fe; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; border: 1px solid #bae6fd; color: #0369a1;">
                üí° <b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (5 ‡∏´‡∏•‡∏±‡∏Å) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πâ Login ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th style="width: 10%;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
                        <th style="width: 10%;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                        <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="studentListTable"></tbody>
            </table>
        </div>

        <div id="admin-tab-stats" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotalStudents">0</div>
                    <div class="stat-label">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTotalLessons">0</div>
                    <div class="stat-label">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAvgScore">0%</div>
                    <div class="stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°</div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div style="background:white; padding:20px; border-radius:10px; border:1px solid #eee;">
                    <h4>üìâ ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                    <div id="statsByLessonContainer">Loading...</div>
                </div>
                <div style="background:white; padding:20px; border-radius:10px; border:1px solid #eee;">
                    <h4>üèÜ Top 5 ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h4>
                    <table class="data-table">
                        <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th></tr></thead>
                        <tbody id="topStudentsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="admin-tab-content" class="hidden" style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 280px;">
                <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h4>
                <div id="adminLessonList" style="height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; background:white; border-radius:6px;"></div>
                <button onclick="prepareNewLesson()" class="btn btn-success w-full" style="margin-top: 10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            
            <div style="flex: 2; min-width: 350px;">
                <div style="background:white; padding:20px; border:1px solid #ddd; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="margin:0;">üìù Editor</h4>
                        <button onclick="previewLesson()" class="btn btn-sm btn-info">üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</button>
                    </div>
                    
                    <input type="text" id="editTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                    <select id="editCategory"></select>
                    <textarea id="editContent" placeholder="HTML Content ‡∏´‡∏£‡∏∑‡∏≠ Embed Code..."></textarea>

                    <hr style="margin: 20px 0;">
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4>üß† ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (Quiz)</h4>
                        <span id="quizCountBadge" class="badge">0 ‡∏Ç‡πâ‡∏≠</span>
                    </div>
                    
                    <button onclick="openQuestionModal()" class="btn btn-outline w-full" style="border-style: dashed; margin-bottom:15px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
                    <div id="qList"></div>

                    <input type="hidden" id="editId">
                    <div class="flex-gap" style="margin-top:20px;">
                        <button onclick="saveLessonToDB()" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="deleteLesson()" class="btn btn-danger">‡∏•‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-tab-monitor" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>üìã ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
                <button onclick="fetchStudentMonitor()" class="btn btn-outline btn-sm">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead><tr><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏£‡∏´‡∏±‡∏™/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡∏à‡∏ö</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="monitorTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="profileModal" class="hidden modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h2>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <button onclick="closeModal('profileModal')" class="btn btn-sm btn-danger">‡∏õ‡∏¥‡∏î</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                <div style="background:#f0f9ff; padding:15px; border-radius:8px;">
                     <h3>‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                     <h1 id="profileTotalTime" style="color:var(--primary); margin:0;">0 ‡∏ô‡∏≤‡∏ó‡∏µ</h1>
                </div>
                <div style="background:#ecfdf5; padding:15px; border-radius:8px;">
                     <h3>‚úÖ ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h3>
                     <h1 id="profileCompletedCount" style="color:var(--success); margin:0;">0 ‡∏ö‡∏ó</h1>
                </div>
            </div>
            <table class="data-table"><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏ú‡∏•</th></tr></thead><tbody id="profileQuizTable"></tbody></table>
        </div>
    </div>

    <div id="studentModal" class="hidden modal-overlay">
        <div class="modal-box" style="max-width:500px;">
            <div class="modal-header">
                <h3 id="studentModalTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <button onclick="closeModal('studentModal')" class="btn btn-sm btn-danger">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
            <input type="hidden" id="editStudentId">
            
            <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (5 ‡∏´‡∏•‡∏±‡∏Å) <span style="color:red">* ‡πÉ‡∏ä‡πâ Login</span>:</label>
            <input type="number" id="formStdCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 66001" style="background:#f0fdf4; border-color:#22c55e;">
            
            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
            <input type="text" id="formStdName">
            
            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</label>
            <input type="text" id="formStdClass" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.2/1">
            
            <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö):</label>
            <input type="number" id="formStdNumber">
            
            <button onclick="saveStudent()" class="btn btn-primary w-full" style="margin-top:15px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>

    <div id="questionModal" class="hidden modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <h3>‚úèÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h3>
                <button onclick="closeModal('questionModal')" class="btn btn-sm btn-danger">‡∏õ‡∏¥‡∏î</button>
            </div>
            <textarea id="qInputText" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..." style="height: 80px;"></textarea>
            <div style="margin:10px 0;">
                <button onclick="addOptionInput()" class="btn btn-sm btn-success">+ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                <small style="color:var(--primary); margin-left:10px;">*‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å</small>
            </div>
            <div id="optionInputsContainer"></div>
            <button onclick="saveQuestionToMemory()" class="btn btn-primary w-full" style="margin-top:15px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
    </div>

    <div id="previewModal" class="hidden modal-overlay">
        <div class="modal-box" style="background: #f3f4f6;">
            <div class="modal-header">
                <h3>üëÅÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå (Preview Mode)</h3>
                <button onclick="closeModal('previewModal')" class="btn btn-sm btn-danger">‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
            </div>
            <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                <h2 id="previewTitle" style="color:var(--primary); margin-top:0;"></h2>
                <hr style="margin: 15px 0;">
                <div id="previewContent" class="preview-box" style="background:white; border:none; padding:0;"></div>
                <div id="previewQuiz" style="margin-top:20px; border-top:2px dashed #eee; padding-top:20px;">
                    <h4>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö:</h4>
                    <div id="previewQuizContent"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="adminDetailModal" class="hidden modal-overlay">
        <div class="modal-box">
             <div class="modal-header">
                <h2 id="admDetailTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>
                <button onclick="closeModal('adminDetailModal')" class="btn btn-sm btn-danger">‡∏õ‡∏¥‡∏î</button>
             </div>
             <table class="data-table"><tbody id="admDetailBody"></tbody></table>
        </div>
    </div>

</div>

<script>
    // --- Config & Init ---
    const SUPABASE_URL = 'https://fddkpkcmkvitjkouxerg.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZGtwa2Nta3ZpdGprb3V4ZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDIxMjQsImV4cCI6MjA4MzAxODEyNH0.7OLB2igeXv3ZbLYQ2AJf-HxGpgyxqjwfAjrDG1rhP3E';

    const UNITS = {
        'unit1': '1. ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
        'unit2': '2. ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
        'unit3': '3. ‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå',
        'unit4': '4. ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£',
        'unit5': '5. ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
        'unit6': '6. ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        'unit7': '7. ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏ô‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        'unit8': '8. ‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡∏ï‡∏¥‡∏á'
    };

    let dbClient;
    try { dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e){ console.error(e); }

    let currentUser = null;
    let currentLesson = null;
    let editingQuizData = [];
    let allLessonsCache = [];
    let editingQuestionIndex = -1;
    let allStudentsCache = [];

    window.onload = function() {
        initTopicGrid();
        initAdminSelect();
    };

    function initTopicGrid() {
        const grid = document.getElementById('topicGrid');
        grid.innerHTML = '';
        Object.keys(UNITS).forEach((key, index) => {
            const div = document.createElement('div');
            div.className = 'menu-card';
            div.onclick = () => loadLessonGroup(key);
            div.innerHTML = `<div class="topic-number">${index + 1}</div>
                             <div class="topic-content"><h3 style="color:var(--primary); margin:0;">${UNITS[key]}</h3>
                             <small style="color:#6b7280;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</small></div>`;
            grid.appendChild(div);
        });
    }

    function initAdminSelect() {
        const sel = document.getElementById('editCategory');
        sel.innerHTML = '';
        Object.keys(UNITS).forEach(key => {
            const opt = document.createElement('option');
            opt.value = key; opt.innerText = UNITS[key];
            sel.appendChild(opt);
        });
    }

    // --- Authentication ---
    async function handleLogin() {
        const name = document.getElementById('stdName').value.trim();
        const code = document.getElementById('stdCodeInput').value.trim();

        if(!name || !code) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");

        // Admin Login
        if(name.toLowerCase() === 'admin' && code === '1234') {
            currentUser = { role: 'admin', name: 'Administrator' };
            switchPage('adminDashboard');
            switchAdminTab('students'); // Changed default to Students tab
            return;
        }

        // Student Login (Updated to use student_code)
        // Note: Using student_code as main identifier
        let { data: user, error } = await dbClient.from('student_progress')
            .select('*')
            .eq('student_name', name)
            .eq('student_code', code) // Changed from student_number to student_code
            .single();

        if (!user) {
             // Fallback for old system or if they type student_number by mistake
             // Try fetching by old number to be safe, or just return error
             return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (5 ‡∏´‡∏•‡∏±‡∏Å) ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠");
        } else {
            await dbClient.from('student_progress').update({ last_login: new Date() }).eq('id', user.id);
        }

        currentUser = user;
        if(!currentUser.study_time) currentUser.study_time = {};
        if(!currentUser.completed_lessons) currentUser.completed_lessons = [];
        document.getElementById('userDisplay').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${currentUser.student_name}`;
        document.getElementById('userInfo').classList.remove('hidden');
        switchPage('studentDashboard');
    }

    function logout() { location.reload(); }
    function switchPage(pid) {
        ['loginSection','studentDashboard','adminDashboard'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(pid).classList.remove('hidden');
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    // --- Student Logic ---
    async function loadLessonGroup(key) {
        const { data } = await dbClient.from('lessons').select('*').eq('category', key).single();
        if(!data) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤");
        
        currentLesson = data;
        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('contentArea').classList.remove('hidden');
        document.getElementById('lessonTitle').innerText = UNITS[key];
        switchContentTab('learn');
    }

    function switchContentTab(tab) {
        document.querySelectorAll('#contentArea .tab-btn').forEach(b => b.classList.remove('active'));
        if(tab === 'learn') {
            document.querySelectorAll('#contentArea .tab-btn')[0].classList.add('active');
            document.getElementById('view-learn').classList.remove('hidden');
            document.getElementById('view-quiz').classList.add('hidden');
            document.getElementById('lessonViewer').innerHTML = currentLesson.content;
            
            if(!currentUser.completed_lessons.includes(currentLesson.id)) {
                currentUser.completed_lessons.push(currentLesson.id);
                dbClient.from('student_progress').update({ completed_lessons: currentUser.completed_lessons }).eq('id', currentUser.id).then();
            }
        } else {
            document.querySelectorAll('#contentArea .tab-btn')[1].classList.add('active');
            document.getElementById('view-learn').classList.add('hidden');
            document.getElementById('view-quiz').classList.remove('hidden');
            renderStudentQuiz();
        }
    }

    function renderStudentQuiz() {
        const div = document.getElementById('quizArea');
        div.innerHTML = '';
        if(!currentLesson.quiz_data || !currentLesson.quiz_data.length) return div.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</p>';
        
        currentLesson.quiz_data.forEach((q, i) => {
            let opts = '';
            q.options.forEach((o, oi) => opts += `<label style="display:block; margin:5px 0;"><input type="radio" name="q${i}" value="${oi}"> ${o}</label>`);
            div.innerHTML += `<div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;"><b>‡∏Ç‡πâ‡∏≠ ${i+1}. ${q.question}</b>${opts}</div>`;
        });
        div.innerHTML += `<button onclick="submitQuiz()" class="btn btn-primary">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>`;
    }

    async function submitQuiz() {
        let score = 0;
        currentLesson.quiz_data.forEach((q, i) => {
            const chk = document.querySelector(`input[name="q${i}"]:checked`);
            if(chk && parseInt(chk.value) === parseInt(q.correct)) score++;
        });
        alert(`‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${score} / ${currentLesson.quiz_data.length}`);
        await dbClient.from('quiz_results').insert([{
             student_id: currentUser.id, lesson_id: currentLesson.id, score: score, total_score: currentLesson.quiz_data.length, passed: (score/currentLesson.quiz_data.length >= 0.5)
        }]);
        backToDash();
    }
    
    function backToDash() {
        document.getElementById('contentArea').classList.add('hidden');
        document.getElementById('mainMenu').classList.remove('hidden');
    }

    // --- Admin System ---
    function switchAdminTab(tab) {
        document.querySelectorAll('#adminDashboard .tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        ['stats','students','content','monitor'].forEach(t => document.getElementById(`admin-tab-${t}`).classList.add('hidden'));
        document.getElementById(`admin-tab-${tab}`).classList.remove('hidden');

        if(tab === 'stats') loadDashboardStats();
        if(tab === 'students') loadStudentList();
        if(tab === 'content') fetchLessonsForAdmin();
        if(tab === 'monitor') fetchStudentMonitor();
    }

    // 1. Stats Logic
    async function loadDashboardStats() {
        const { data: students } = await dbClient.from('student_progress').select('*');
        const { data: lessons } = await dbClient.from('lessons').select('id, category, title');
        const { data: results } = await dbClient.from('quiz_results').select('*');

        document.getElementById('statTotalStudents').innerText = students.length;
        document.getElementById('statTotalLessons').innerText = lessons.length;
        
        let totalScore = 0, totalMax = 0;
        results.forEach(r => { totalScore += r.score; totalMax += r.total_score; });
        const avg = totalMax > 0 ? Math.round((totalScore/totalMax)*100) : 0;
        document.getElementById('statAvgScore').innerText = `${avg}%`;

        const container = document.getElementById('statsByLessonContainer');
        container.innerHTML = '';
        lessons.forEach(l => {
            const lessonResults = results.filter(r => r.lesson_id === l.id);
            const passed = lessonResults.filter(r => r.passed).length;
            const percent = lessonResults.length > 0 ? Math.round((passed/lessonResults.length)*100) : 0;
            
            container.innerHTML += `
                <div style="margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                        <span>${UNITS[l.category] || l.title}</span>
                        <span>${percent}% ‡∏ú‡πà‡∏≤‡∏ô (${passed}/${lessonResults.length})</span>
                    </div>
                    <div class="progress-container"><div class="progress-bar" style="width:${percent}%"></div></div>
                </div>
            `;
        });

        const studentScores = students.map(s => {
            const myResults = results.filter(r => r.student_id === s.id);
            const total = myResults.reduce((acc, curr) => acc + curr.score, 0);
            return { name: s.student_name, score: total };
        }).sort((a,b) => b.score - a.score).slice(0, 5);

        const topTable = document.getElementById('topStudentsTable');
        topTable.innerHTML = '';
        studentScores.forEach(s => topTable.innerHTML += `<tr><td>${s.name}</td><td><b>${s.score}</b></td></tr>`);
    }

    // 2. Student Management Logic (Updated for student_code)
    async function loadStudentList() {
        const { data } = await dbClient.from('student_progress').select('*').order('student_code');
        allStudentsCache = data;
        const tb = document.getElementById('studentListTable');
        tb.innerHTML = '';
        data.forEach(s => {
            const lastLogin = s.last_login ? new Date(s.last_login).toLocaleString('th-TH') : '-';
            // Show Student Code and Student Number
            tb.innerHTML += `
                <tr>
                    <td><b>${s.student_code || '-'}</b></td>
                    <td>${s.student_name}</td>
                    <td>${s.student_class}</td>
                    <td>${s.student_number}</td>
                    <td>${lastLogin}</td>
                    <td>
                        <button onclick="editStudent(${s.id})" class="btn btn-sm btn-outline">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteStudentUser(${s.id})" class="btn btn-sm btn-danger">üóë ‡∏•‡∏ö</button>
                    </td>
                </tr>
            `;
        });
    }

    function openStudentModal() {
        document.getElementById('studentModalTitle').innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà";
        document.getElementById('editStudentId').value = '';
        document.getElementById('formStdName').value = '';
        document.getElementById('formStdClass').value = '';
        document.getElementById('formStdNumber').value = '';
        document.getElementById('formStdCode').value = '';
        document.getElementById('studentModal').classList.remove('hidden');
    }

    function editStudent(id) {
        const s = allStudentsCache.find(x => x.id === id);
        document.getElementById('studentModalTitle').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
        document.getElementById('editStudentId').value = s.id;
        document.getElementById('formStdName').value = s.student_name;
        document.getElementById('formStdClass').value = s.student_class;
        document.getElementById('formStdNumber').value = s.student_number;
        document.getElementById('formStdCode').value = s.student_code; // Load code
        document.getElementById('studentModal').classList.remove('hidden');
    }

    async function saveStudent() {
        const id = document.getElementById('editStudentId').value;
        const payload = {
            student_name: document.getElementById('formStdName').value,
            student_class: document.getElementById('formStdClass').value,
            student_number: document.getElementById('formStdNumber').value,
            student_code: document.getElementById('formStdCode').value
        };

        if(!payload.student_name || !payload.student_code) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
        if(payload.student_code.length !== 5) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 5 ‡∏´‡∏•‡∏±‡∏Å");

        let err;
        if(id) {
            const { error } = await dbClient.from('student_progress').update(payload).eq('id', id);
            err = error;
        } else {
            // New user, init empty progress
            payload.study_time = {};
            payload.completed_lessons = [];
            const { error } = await dbClient.from('student_progress').insert([payload]);
            err = error;
        }

        if(err) alert("Error: " + err.message);
        else {
            closeModal('studentModal');
            loadStudentList(); 
        }
    }

    async function deleteStudentUser(id) {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")) {
            await dbClient.from('student_progress').delete().eq('id', id);
            loadStudentList();
        }
    }

    // 3. Content Logic
    async function fetchLessonsForAdmin() {
        const { data } = await dbClient.from('lessons').select('*').order('category');
        allLessonsCache = data || [];
        const list = document.getElementById('adminLessonList');
        list.innerHTML = '';
        allLessonsCache.forEach(l => {
            const d = document.createElement('div');
            d.style.padding='10px'; d.style.borderBottom='1px solid #eee'; d.style.cursor='pointer';
            d.innerHTML = `<b>${l.category}</b>: ${l.title}`;
            d.onclick = () => loadAdminEditor(l);
            list.appendChild(d);
        });
    }

    function prepareNewLesson() {
        document.getElementById('editId').value = '';
        document.getElementById('editTitle').value = '';
        document.getElementById('editContent').value = '';
        editingQuizData = [];
        renderAdminQuizBuilder();
    }

    function loadAdminEditor(l) {
        document.getElementById('editId').value = l.id;
        document.getElementById('editTitle').value = l.title;
        document.getElementById('editCategory').value = l.category;
        document.getElementById('editContent').value = l.content;
        editingQuizData = l.quiz_data || [];
        renderAdminQuizBuilder();
    }

    function previewLesson() {
        const title = document.getElementById('editTitle').value || "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
        const content = document.getElementById('editContent').value || "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</p>";
        
        document.getElementById('previewTitle').innerText = title;
        document.getElementById('previewContent').innerHTML = content;

        const qDiv = document.getElementById('previewQuizContent');
        qDiv.innerHTML = '';
        if(editingQuizData.length > 0) {
            editingQuizData.forEach((q, i) => {
                 qDiv.innerHTML += `<p>${i+1}. ${q.question} (‡πÄ‡∏â‡∏•‡∏¢: ${q.options[q.correct]})</p>`;
            });
        } else {
            qDiv.innerHTML = '<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</i>';
        }

        document.getElementById('previewModal').classList.remove('hidden');
    }

    function renderAdminQuizBuilder() {
        const list = document.getElementById('qList');
        list.innerHTML = '';
        document.getElementById('quizCountBadge').innerText = `${editingQuizData.length} ‡∏Ç‡πâ‡∏≠`;
        editingQuizData.forEach((q, idx) => {
            const d = document.createElement('div');
            d.className = 'quiz-editor-card';
            d.innerHTML = `<div><b>${idx+1}. ${q.question}</b><br><small>‡πÄ‡∏â‡∏•‡∏¢: ${q.options[q.correct]}</small></div>
                           <div class="quiz-actions">
                               <button onclick="editQuestion(${idx})" class="btn btn-sm btn-outline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                               <button onclick="removeQuestion(${idx})" class="btn btn-sm btn-danger">‡∏•‡∏ö</button>
                           </div>`;
            list.appendChild(d);
        });
    }

    function openQuestionModal() {
        editingQuestionIndex = -1;
        document.getElementById('qInputText').value = '';
        document.getElementById('optionInputsContainer').innerHTML = '';
        addOptionInput(); addOptionInput();
        document.getElementById('questionModal').classList.remove('hidden');
    }

    function addOptionInput(val='', isC=false) {
        const div = document.createElement('div');
        div.className = 'opt-row';
        div.innerHTML = `<input type="radio" name="corr" ${isC?'checked':''}> <input type="text" class="opt-val" value="${val}" style="margin:0;">`;
        document.getElementById('optionInputsContainer').appendChild(div);
    }

    function saveQuestionToMemory() {
        const q = document.getElementById('qInputText').value;
        const opts = []; let c = -1;
        document.querySelectorAll('#optionInputsContainer .opt-row').forEach((r, i) => {
            opts.push(r.querySelector('.opt-val').value);
            if(r.querySelector('input[name="corr"]').checked) c = i;
        });
        if(c === -1 || opts.length < 2) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
        
        const obj = { question: q, options: opts, correct: c };
        if(editingQuestionIndex === -1) editingQuizData.push(obj);
        else editingQuizData[editingQuestionIndex] = obj;
        
        renderAdminQuizBuilder();
        closeModal('questionModal');
    }

    function editQuestion(i) {
        editingQuestionIndex = i;
        const q = editingQuizData[i];
        document.getElementById('qInputText').value = q.question;
        document.getElementById('optionInputsContainer').innerHTML = '';
        q.options.forEach((o, idx) => addOptionInput(o, idx===parseInt(q.correct)));
        document.getElementById('questionModal').classList.remove('hidden');
    }

    function removeQuestion(i) {
        editingQuizData.splice(i, 1);
        renderAdminQuizBuilder();
    }

    async function saveLessonToDB() {
        const id = document.getElementById('editId').value;
        const payload = {
            title: document.getElementById('editTitle').value,
            category: document.getElementById('editCategory').value,
            content: document.getElementById('editContent').value,
            quiz_data: editingQuizData
        };
        const { error } = id ? await dbClient.from('lessons').update(payload).eq('id', id)
                             : await dbClient.from('lessons').insert([payload]);
        if(error) alert(error.message); else { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß"); fetchLessonsForAdmin(); }
    }

    async function deleteLesson() {
        const id = document.getElementById('editId').value;
        if(id && confirm("‡∏•‡∏ö?")) {
            await dbClient.from('lessons').delete().eq('id', id);
            fetchLessonsForAdmin(); prepareNewLesson();
        }
    }

    // 4. Monitor Logic (Simple)
    async function fetchStudentMonitor() {
        const { data } = await dbClient.from('student_progress').select('*').order('last_login', {ascending:false});
        const tb = document.getElementById('monitorTableBody');
        tb.innerHTML = '';
        data.forEach(s => {
            tb.innerHTML += `<tr>
                <td>${new Date() - new Date(s.last_login) < 300000 ? 'üü¢ Online' : '‚ö™ Offline'}</td>
                <td>${s.student_name}</td>
                <td>${s.student_code} / ${s.student_number}</td>
                <td>${s.completed_lessons ? s.completed_lessons.length : 0} ‡∏ö‡∏ó</td>
                <td>0</td>
                <td><button class="btn btn-sm btn-info">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
            </tr>`;
        });
    }

</script>
</body>
</html>

