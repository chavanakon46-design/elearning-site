<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏•‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏¥‡∏á KRU DREAM (V.4.2 Complete)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô --- */
        :root {
            --primary: #2563eb; 
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }

        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-height: 85vh; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 120px; font-family: monospace; }
        
        .btn { display: inline-block; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; transition: 0.2s; text-align: center; }
        .btn-sm { padding: 4px 10px; font-size: 0.85rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--text-main); }
        .btn-outline:hover { background: #eff6ff; border-color: var(--primary); color: var(--primary); }
        
        /* Utilities */
        .hidden { display: none !important; }
        .flex-gap { display: flex; gap: 10px; flex-wrap: wrap; }
        .badge { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; }
        .badge-time { background: #e0f2fe; color: #075985; padding: 4px 10px; border-radius: 12px; font-weight: bold; }
        .w-full { width: 100%; }

        /* Menu Grid (8 Topics) */
        .grid-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .menu-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; cursor: pointer; background: #fff; transition: 0.2s; position: relative; overflow: hidden; }
        .menu-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
        .topic-number { font-size: 3rem; font-weight: 900; color: #f3f4f6; position: absolute; right: -10px; top: -10px; z-index: 0; }
        .topic-content { position: relative; z-index: 1; }

        /* Lesson & Quiz Viewer */
        .lesson-viewer { background: #f8fafc; padding: 25px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .quiz-container { background: white; padding: 20px; border-radius: 8px; border: 1px solid #cbd5e1; margin-top: 20px; }
        .question-box { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .option-label { display: block; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; margin-top: 5px; cursor: pointer; transition: 0.2s; }
        .option-label:hover { background: #f1f5f9; }
        .option-label input { width: auto; margin-right: 10px; }

        /* Admin & Profile Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .data-table th, .data-table td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
        .data-table th { background: #f3f4f6; font-weight: 600; }
        .status-pass { color: #166534; background: #dcfce7; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .status-fail { color: #991b1b; background: #fee2e2; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        /* Modal General */
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; display:flex; justify-content:center; align-items:center; }
        .modal-box { background:white; width:90%; max-width:900px; padding:25px; border-radius:10px; max-height:90vh; overflow-y:auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }

        /* Tabs */
        .tab-group { border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; display: flex; gap: 20px; }
        .tab-btn { padding: 10px 0; cursor: pointer; color: #6b7280; border-bottom: 3px solid transparent; font-weight: 600; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* --- CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quiz Editor ‡πÉ‡∏´‡∏°‡πà (New Feature) --- */
        .quiz-editor-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; position: relative; transition: 0.2s; }
        .quiz-editor-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-color: var(--primary); }
        .quiz-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        
        /* Modal Form Styles */
        .q-modal-body { max-height: 70vh; overflow-y: auto; padding-right: 5px; }
        .opt-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: #f8fafc; padding: 8px; border-radius: 6px; border: 1px solid #f1f5f9; }
        .opt-radio { width: 20px; height: 20px; cursor: pointer; }
        .opt-input { flex: 1; margin: 0 !important; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #94a3b8; transition: 0.2s; }
        .btn-icon:hover { color: var(--danger); }
    </style>
</head>
<body>

<div class="container">
    
    <header class="header">
        <div>
            <h1 style="margin:0; color: var(--primary);">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏µ‡πÄ‡∏•‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏¥‡∏á KRU DREAM</h1>
            <small style="color: #6b7280;">Computer Science E-Learning</small>
        </div>
        <div id="userInfo" class="hidden text-right">
            <div style="margin-bottom: 5px;">
                <span id="userDisplay" style="font-weight: bold; font-size: 1.1rem;"></span>
            </div>
            <div class="flex-gap" style="justify-content: flex-end; align-items: center;">
                <div id="timerDisplay" class="badge-time hidden">‚è± 00:00</div>
                <button onclick="openProfile()" class="btn btn-sm btn-outline">üë§ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
                <button onclick="logout()" class="btn btn-sm btn-danger">‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>
    </header>

    <div id="loginSection" class="text-center" style="padding: 60px 0;">
        <h2 style="color: var(--text-main);">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</h2>
        <div style="max-width: 350px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; border: 1px solid #e5e7eb;">
            <input type="text" id="stdName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            <input type="text" id="stdClass" placeholder="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏°.2/1)">
            <input type="number" id="stdNumber" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà">
            <button onclick="handleLogin()" class="btn btn-primary w-full" style="margin-top: 15px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="studentDashboard" class="hidden">
        <div id="mainMenu">
            <h3 style="margin-bottom: 20px;">üìö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <div class="grid-menu" id="topicGrid"></div>
        </div>

        <div id="contentArea" class="hidden">
            <div class="header" style="border:none; padding-bottom:0; margin-bottom: 10px;">
                <h2 id="lessonTitle" style="margin:0;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <button onclick="backToDash()" class="btn btn-outline btn-sm">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            </div>

            <div class="tab-group">
                <div class="tab-btn active" onclick="switchContentTab('learn')">üìñ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                <div class="tab-btn" onclick="switchContentTab('quiz')">üìù ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
            </div>

            <div id="view-learn">
                <div id="lessonViewer" class="lesson-viewer">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>

            <div id="view-quiz" class="hidden">
                <div id="quizArea" class="quiz-container"></div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="hidden modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <button onclick="closeProfile()" class="btn btn-sm btn-danger">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin: 20px 0;">
                <div style="background:#f0f9ff; padding:15px; border-radius:8px;">
                    <h3>‚è≥ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <h1 id="profileTotalTime" style="color:var(--primary); margin:0;">0 ‡∏ô‡∏≤‡∏ó‡∏µ</h1>
                </div>
                <div style="background:#ecfdf5; padding:15px; border-radius:8px;">
                    <h3>‚úÖ ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</h3>
                    <h1 id="profileCompletedCount" style="color:var(--success); margin:0;">0 ‡∏ö‡∏ó</h1>
                </div>
            </div>

            <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Real-time)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö</th>
                        <th>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                        <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                        <th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
                    </tr>
                </thead>
                <tbody id="profileQuizTable"></tbody>
            </table>
        </div>
    </div>

    <div id="adminDashboard" class="hidden">
        <div style="background:#fff7ed; padding:15px; border-radius:8px; border:1px solid #fdba74; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:#9a3412;">üîß ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h3>
            <button onclick="logout()" class="btn btn-danger btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin</button>
        </div>

        <div class="tab-group">
            <div class="tab-btn active" onclick="switchAdminTab('content')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ & ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>
            <div class="tab-btn" onclick="switchAdminTab('monitor')">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        </div>

        <div id="admin-tab-content" style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 280px;">
                <h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h4>
                <div id="adminLessonList" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; background:white;"></div>
                <button onclick="prepareNewLesson()" class="btn btn-success w-full" style="margin-top: 10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            
            <div style="flex: 2; min-width: 350px;">
                <div style="background:white; padding:20px; border:1px solid #ddd; border-radius:8px;">
                    <h4 style="margin-top:0;">üìù Editor</h4>
                    <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
                    <input type="text" id="editTitle">
                    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Unit):</label>
                    <select id="editCategory"></select>
                    <label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (HTML / Embed Code):</label>
                    <textarea id="editContent" placeholder="<p>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤...</p>"></textarea>

                    <hr style="margin: 20px 0;">
                    
                    <h4>üß† ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Quiz Builder)</h4>
                    <div id="quizBuilderArea" style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:15px;">
                        <button onclick="openQuestionModal()" class="btn btn-outline w-full" style="border-style: dashed; padding: 15px;">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
                        </button>
                        
                        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight:bold; color:#64748b;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</span>
                            <span id="quizCountBadge" class="badge">0 ‡∏Ç‡πâ‡∏≠</span>
                        </div>

                        <div id="qList" style="margin-top: 15px;"></div>
                    </div>

                    <input type="hidden" id="editId">
                    <div class="flex-gap">
                        <button onclick="saveLessonToDB()" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="deleteLesson()" class="btn btn-danger">‡∏•‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-tab-monitor" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <button onclick="fetchStudentMonitor()" class="btn btn-outline btn-sm">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            
            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width:100px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏ä‡∏±‡πâ‡∏ô/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th>‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡∏à‡∏ö</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="monitorTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="adminDetailModal" class="hidden modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h2 id="admDetailTitle" style="margin:0;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <button onclick="closeAdminDetail()" class="btn btn-sm btn-danger">‡∏õ‡∏¥‡∏î</button>
            </div>
            
            <div style="margin-top:20px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Unit)</th>
                            <th style="text-align:center;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö</th>
                            <th style="text-align:center;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                            <th style="text-align:center;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</th>
                        </tr>
                    </thead>
                    <tbody id="admDetailBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="questionModal" class="hidden modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--primary);">‚úèÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h3>
                <button onclick="closeQuestionModal()" class="btn btn-sm btn-danger">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
            
            <div class="q-modal-body">
                <label><b>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</b></label>
                <textarea id="qInputText" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." style="height: 80px;"></textarea>

                <div style="margin-top: 15px; margin-bottom: 5px; display:flex; justify-content:space-between;">
                    <label><b>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:</b> <small style="color:var(--primary);">(‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)</small></label>
                    <button onclick="addOptionInput()" class="btn btn-sm btn-success" style="width:auto;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                </div>
                
                <div id="optionInputsContainer">
                    </div>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; text-align: right;">
                <button onclick="saveQuestionToMemory()" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- Config ---
    const SUPABASE_URL = 'https://fddkpkcmkvitjkouxerg.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZGtwa2Nta3ZpdGprb3V4ZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDIxMjQsImV4cCI6MjA4MzAxODEyNH0.7OLB2igeXv3ZbLYQ2AJf-HxGpgyxqjwfAjrDG1rhP3E';

    const UNITS = {
        'unit1': '1. ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
        'unit2': '2. ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
        'unit3': '3. ‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå',
        'unit4': '4. ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£',
        'unit5': '5. ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
        'unit6': '6. ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        'unit7': '7. ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏ô‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï',
        'unit8': '8. ‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡∏ï‡∏¥‡∏á'
    };

    let dbClient;
    try {
        dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) { console.error("DB Error", e); }

    // State Variables
    let currentUser = null;
    let currentLesson = null;
    let studyTimer = null;
    let secondsSpent = 0;
    
    // Admin State
    let editingQuizData = [];
    let allLessonsCache = [];
    let editingQuestionIndex = -1; // -1 = Add New, 0+ = Edit Existing

    // --- Init ---
    window.onload = function() {
        initTopicGrid();
        initAdminSelect();
    };

    function initTopicGrid() {
        const grid = document.getElementById('topicGrid');
        grid.innerHTML = '';
        Object.keys(UNITS).forEach((key, index) => {
            const div = document.createElement('div');
            div.className = 'menu-card';
            div.onclick = () => loadLessonGroup(key);
            div.innerHTML = `
                <div class="topic-number">${index + 1}</div>
                <div class="topic-content">
                    <h3 style="margin-top:0; color:var(--primary);">${UNITS[key]}</h3>
                    <small style="color:#6b7280;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</small>
                </div>
            `;
            grid.appendChild(div);
        });
    }

    function initAdminSelect() {
        const sel = document.getElementById('editCategory');
        sel.innerHTML = '';
        Object.keys(UNITS).forEach(key => {
            const opt = document.createElement('option');
            opt.value = key;
            opt.innerText = UNITS[key];
            sel.appendChild(opt);
        });
    }

    // --- Auth Logic ---
    async function handleLogin() {
        if (!dbClient) return alert("Connection Error");
        const name = document.getElementById('stdName').value.trim();
        const sClass = document.getElementById('stdClass').value.trim();
        const code = document.getElementById('stdNumber').value.trim();

        if (!name || !code) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        if (name.toLowerCase() === 'admin' && code === '1234') {
            currentUser = { role: 'admin', name: 'Administrator' };
            switchPage('adminDashboard');
            fetchLessonsForAdmin();
            fetchStudentMonitor();
            return;
        }

        let { data: user, error } = await dbClient.from('student_progress')
            .select('*').eq('student_name', name).eq('student_number', code).single();

        if (!user) {
            const { data: newUser, error: err } = await dbClient.from('student_progress')
                .insert([{ 
                    student_name: name, 
                    student_class: sClass, 
                    student_number: code,
                    study_time: {},
                    completed_lessons: []
                }]).select().single();
            if (err) return alert("Login Failed: " + err.message);
            user = newUser;
        } else {
            await dbClient.from('student_progress').update({ last_login: new Date() }).eq('id', user.id);
        }

        currentUser = user;
        if(!currentUser.study_time) currentUser.study_time = {};
        if(!currentUser.completed_lessons) currentUser.completed_lessons = [];

        document.getElementById('userDisplay').innerText = `‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${currentUser.student_name}`;
        document.getElementById('userInfo').classList.remove('hidden');
        switchPage('studentDashboard');
    }

    function logout() {
        stopLessonTimer();
        location.reload();
    }

    function switchPage(pageId) {
        ['loginSection', 'studentDashboard', 'adminDashboard'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
    }

    // --- Student Logic ---
    async function loadLessonGroup(categoryKey) {
        const { data } = await dbClient.from('lessons').select('*').eq('category', categoryKey).limit(1).single();
        if (!data) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ");

        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('contentArea').classList.remove('hidden');
        
        currentLesson = data;
        document.getElementById('lessonTitle').innerText = UNITS[categoryKey] || currentLesson.title;
        switchContentTab('learn');
    }

    function switchContentTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if (tab === 'learn') {
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.getElementById('view-learn').classList.remove('hidden');
            document.getElementById('view-quiz').classList.add('hidden');
            renderLessonContent();
        } else {
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.getElementById('view-learn').classList.add('hidden');
            document.getElementById('view-quiz').classList.remove('hidden');
            stopLessonTimer();
            renderQuiz();
        }
    }

    function renderLessonContent() {
        document.getElementById('lessonViewer').innerHTML = currentLesson.content;
        stopLessonTimer();
        secondsSpent = 0;
        document.getElementById('timerDisplay').classList.remove('hidden');
        
        studyTimer = setInterval(() => {
            secondsSpent++;
            const mins = Math.floor(secondsSpent / 60).toString().padStart(2, '0');
            const secs = (secondsSpent % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').innerText = `‚è± ${mins}:${secs}`;
        }, 1000);

        if(!currentUser.completed_lessons.includes(currentLesson.id)) {
             currentUser.completed_lessons.push(currentLesson.id);
             dbClient.from('student_progress').update({
                 completed_lessons: currentUser.completed_lessons
             }).eq('id', currentUser.id).then(()=>{});
        }
    }

    async function stopLessonTimer() {
        if (currentLesson && studyTimer) {
            clearInterval(studyTimer);
            document.getElementById('timerDisplay').classList.add('hidden');
            
            const existingTime = currentUser.study_time[currentLesson.category] || 0;
            const newTotal = existingTime + secondsSpent;
            currentUser.study_time[currentLesson.category] = newTotal;

            await dbClient.from('student_progress').update({ 
                study_time: currentUser.study_time
            }).eq('id', currentUser.id);

            secondsSpent = 0;
            studyTimer = null;
        }
    }

    function backToDash() {
        stopLessonTimer();
        document.getElementById('contentArea').classList.add('hidden');
        document.getElementById('mainMenu').classList.remove('hidden');
        currentLesson = null;
    }

    // --- Student Quiz ---
    function renderQuiz() {
        const container = document.getElementById('quizArea');
        container.innerHTML = '';
        if (!currentLesson.quiz_data || currentLesson.quiz_data.length === 0) {
            container.innerHTML = '<p class="text-center text-sub">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</p>';
            return;
        }

        container.innerHTML = '<h3>üìù ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ' + (UNITS[currentLesson.category] || '') + '</h3>';
        currentLesson.quiz_data.forEach((q, idx) => {
            const box = document.createElement('div');
            box.className = 'question-box';
            let optionsHTML = '';
            q.options.forEach((opt, optIdx) => {
                optionsHTML += `
                    <label class="option-label">
                        <input type="radio" name="q_${idx}" value="${optIdx}"> ${opt}
                    </label>
                `;
            });
            box.innerHTML = `<p><b>‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${idx + 1}:</b> ${q.question}</p><div>${optionsHTML}</div>`;
            container.appendChild(box);
        });

        const btn = document.createElement('button');
        btn.className = 'btn btn-primary';
        btn.innerText = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö';
        btn.onclick = calculateScore;
        container.appendChild(btn);
    }

    async function calculateScore() {
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö?")) return;
        let score = 0;
        const total = currentLesson.quiz_data.length;
        const answers = currentLesson.quiz_data;
        answers.forEach((q, idx) => {
            const selected = document.querySelector(`input[name="q_${idx}"]:checked`);
            if (selected && parseInt(selected.value) === parseInt(q.correct)) score++;
        });

        alert(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${score} / ${total}`);
        const passed = (score / total) >= 0.5;
        await dbClient.from('quiz_results').insert([{
            student_id: currentUser.id,
            lesson_id: currentLesson.id,
            score: score,
            total_score: total,
            passed: passed
        }]);
        backToDash();
    }

    // --- Profile Modal ---
    async function openProfile() {
        let totalSec = 0;
        if(currentUser.study_time) Object.values(currentUser.study_time).forEach(v => totalSec += v);
        document.getElementById('profileTotalTime').innerText = Math.floor(totalSec/60) + " ‡∏ô‡∏≤‡∏ó‡∏µ";
        document.getElementById('profileCompletedCount').innerText = currentUser.completed_lessons.length + " ‡∏ö‡∏ó";

        const { data: history } = await dbClient.from('quiz_results')
            .select(`*, lessons(title, category)`).eq('student_id', currentUser.id).order('created_at', { ascending: false });

        const tbody = document.getElementById('profileQuizTable');
        tbody.innerHTML = '';
        if(history) {
            history.forEach(h => {
                const tr = document.createElement('tr');
                const date = new Date(h.created_at).toLocaleString('th-TH');
                const lessonName = h.lessons ? (UNITS[h.lessons.category] || h.lessons.title) : 'Unknown';
                tr.innerHTML = `<td>${date}</td><td>${lessonName}</td><td>${h.score} / ${h.total_score}</td>
                    <td>${h.passed ? '<span class="status-pass">‡∏ú‡πà‡∏≤‡∏ô</span>' : '<span class="status-fail">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</span>'}</td>`;
                tbody.appendChild(tr);
            });
        }
        document.getElementById('profileModal').classList.remove('hidden');
    }
    function closeProfile() { document.getElementById('profileModal').classList.add('hidden'); }

    // --- Admin System ---
    function switchAdminTab(tab) {
        document.querySelectorAll('#adminDashboard .tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if(tab === 'content') {
            document.getElementById('admin-tab-content').classList.remove('hidden');
            document.getElementById('admin-tab-monitor').classList.add('hidden');
        } else {
            document.getElementById('admin-tab-content').classList.add('hidden');
            document.getElementById('admin-tab-monitor').classList.remove('hidden');
            fetchStudentMonitor();
        }
    }

    async function fetchLessonsForAdmin() {
        const { data } = await dbClient.from('lessons').select('*').order('category');
        allLessonsCache = data || []; 
        const list = document.getElementById('adminLessonList');
        list.innerHTML = '';
        allLessonsCache.forEach(l => {
            const item = document.createElement('div');
            item.style.padding = '10px';
            item.style.borderBottom = '1px solid #eee';
            item.style.cursor = 'pointer';
            item.innerHTML = `<b>${l.category}</b>: ${l.title}`;
            item.onclick = () => loadAdminEditor(l);
            list.appendChild(item);
        });
    }

    function prepareNewLesson() {
        document.getElementById('editId').value = '';
        document.getElementById('editTitle').value = '';
        document.getElementById('editContent').value = '';
        editingQuizData = [];
        renderAdminQuizBuilder();
    }
    
    function loadAdminEditor(l) {
        document.getElementById('editId').value = l.id;
        document.getElementById('editTitle').value = l.title;
        document.getElementById('editCategory').value = l.category;
        document.getElementById('editContent').value = l.content;
        editingQuizData = l.quiz_data || [];
        renderAdminQuizBuilder();
    }

    // --- Advanced Admin Quiz Builder Logic (New) ---

    function renderAdminQuizBuilder() {
        const list = document.getElementById('qList');
        list.innerHTML = '';
        document.getElementById('quizCountBadge').innerText = `${editingQuizData.length} ‡∏Ç‡πâ‡∏≠`;

        editingQuizData.forEach((q, idx) => {
            const correctText = q.options[q.correct];
            const card = document.createElement('div');
            card.className = 'quiz-editor-card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <span style="font-weight:bold; color:var(--primary);">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${idx + 1}</span>
                        <p style="margin: 5px 0 10px 0; font-size: 1.1rem;">${q.question}</p>
                        <div style="font-size: 0.9rem; color: #64748b;">
                            ‡πÄ‡∏â‡∏•‡∏¢: <span class="badge">${correctText}</span> 
                            (‡∏à‡∏≤‡∏Å ${q.options.length} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                        </div>
                    </div>
                </div>
                <div class="quiz-actions">
                    <button onclick="editQuestion(${idx})" class="btn btn-sm btn-outline" style="width:auto;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button onclick="removeQuestion(${idx})" class="btn btn-sm btn-danger" style="width:auto;">üóë ‡∏•‡∏ö</button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    function openQuestionModal() {
        editingQuestionIndex = -1; // Reset to Add Mode
        document.getElementById('qInputText').value = '';
        document.getElementById('optionInputsContainer').innerHTML = '';
        
        // Default 2 options
        addOptionInput();
        addOptionInput();
        
        document.getElementById('questionModal').classList.remove('hidden');
    }

    function closeQuestionModal() {
        document.getElementById('questionModal').classList.add('hidden');
    }

    function addOptionInput(value = '', isCorrect = false) {
        const container = document.getElementById('optionInputsContainer');
        const div = document.createElement('div');
        div.className = 'opt-row';
        div.innerHTML = `
            <input type="radio" name="correctAnswer" class="opt-radio" ${isCorrect ? 'checked' : ''}>
            <input type="text" class="opt-input" value="${value}" placeholder="‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...">
            <button onclick="this.parentElement.remove()" class="btn-icon">√ó</button>
        `;
        container.appendChild(div);
    }

    function saveQuestionToMemory() {
        const qText = document.getElementById('qInputText').value.trim();
        if(!qText) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°");

        const optRows = document.querySelectorAll('#optionInputsContainer .opt-row');
        const options = [];
        let correctIndex = -1;

        optRows.forEach((row, idx) => {
            const val = row.querySelector('.opt-input').value.trim();
            const isChecked = row.querySelector('.opt-radio').checked;
            
            if(val) {
                options.push(val);
                if(isChecked) correctIndex = options.length - 1;
            }
        });

        if(options.length < 2) return alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏Ç‡πâ‡∏≠");
        if(correctIndex === -1) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏•‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤)");

        const questionObj = {
            question: qText,
            options: options,
            correct: correctIndex
        };

        if(editingQuestionIndex === -1) {
            editingQuizData.push(questionObj);
        } else {
            editingQuizData[editingQuestionIndex] = questionObj;
        }

        renderAdminQuizBuilder();
        closeQuestionModal();
    }

    function editQuestion(idx) {
        editingQuestionIndex = idx;
        const q = editingQuizData[idx];
        
        document.getElementById('qInputText').value = q.question;
        const container = document.getElementById('optionInputsContainer');
        container.innerHTML = '';
        
        q.options.forEach((opt, i) => {
            addOptionInput(opt, i === parseInt(q.correct));
        });

        document.getElementById('questionModal').classList.remove('hidden');
    }

    function removeQuestion(idx) {
        if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;
        editingQuizData.splice(idx, 1);
        renderAdminQuizBuilder();
    }

    // --- Admin DB Actions ---
    async function saveLessonToDB() {
        const id = document.getElementById('editId').value;
        const title = document.getElementById('editTitle').value;
        const category = document.getElementById('editCategory').value;
        const content = document.getElementById('editContent').value;
        if (!title) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠");
        
        const payload = { title, category, content, quiz_data: editingQuizData };
        
        let err;
        if(id) { 
            const { error } = await dbClient.from('lessons').update(payload).eq('id', id); 
            err = error; 
        } else { 
            const { error } = await dbClient.from('lessons').insert([payload]); 
            err = error; 
        }
        
        if(err) alert("Error: " + err.message);
        else { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); fetchLessonsForAdmin(); }
    }
    
    async function deleteLesson() {
        const id = document.getElementById('editId').value;
        if(!id || !confirm("‡∏•‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
        await dbClient.from('lessons').delete().eq('id', id);
        fetchLessonsForAdmin(); prepareNewLesson();
    }

    // --- Admin Monitor ---
    let currentMonitorStudents = [];

    async function fetchStudentMonitor() {
        if(allLessonsCache.length === 0) await fetchLessonsForAdmin();

        const { data: students } = await dbClient.from('student_progress').select('*').order('last_login', {ascending:false});
        currentMonitorStudents = students || [];
        const tbody = document.getElementById('monitorTableBody');
        tbody.innerHTML = '';
        
        currentMonitorStudents.forEach((s, idx) => {
            let totalSec = 0;
            if(s.study_time) Object.values(s.study_time).forEach(v => totalSec+=v);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${new Date() - new Date(s.last_login) < 300000 ? '<span class="status-pass">üü¢ Online</span>' : '<span style="color:#9ca3af">‚ö™ Offline</span>'}</td>
                <td>${s.student_name}</td>
                <td>${s.student_class} #${s.student_number}</td>
                <td>${s.completed_lessons ? s.completed_lessons.length : 0} / 8</td>
                <td>${Math.floor(totalSec/60)} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                <td><button onclick="viewStudentDetails(${idx})" class="btn btn-sm btn-primary">üìÑ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function viewStudentDetails(idx) {
        const s = currentMonitorStudents[idx];
        document.getElementById('admDetailTitle').innerText = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${s.student_name}`;
        
        const { data: quizzes } = await dbClient.from('quiz_results').select('*').eq('student_id', s.id);
        
        const tbody = document.getElementById('admDetailBody');
        tbody.innerHTML = '';

        Object.keys(UNITS).forEach(unitKey => {
            const unitName = UNITS[unitKey];
            const lessonObj = allLessonsCache.find(l => l.category === unitKey);
            
            let isCompleted = false;
            if(lessonObj && s.completed_lessons && s.completed_lessons.includes(lessonObj.id)) isCompleted = true;

            const timeSec = (s.study_time && s.study_time[unitKey]) ? s.study_time[unitKey] : 0;

            let scoreText = "-";
            if(lessonObj && quizzes) {
                const lessonQuizzes = quizzes.filter(q => q.lesson_id === lessonObj.id);
                if(lessonQuizzes.length > 0) {
                    const latest = lessonQuizzes[lessonQuizzes.length - 1];
                    scoreText = `${latest.score} / ${latest.total_score} (${latest.passed ? '‡∏ú‡πà‡∏≤‡∏ô':'‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'})`;
                }
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${unitName}</td>
                <td style="text-align:center;">${isCompleted ? '<span class="status-pass">‚úÖ ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>' : '<span style="color:#ccc">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö</span>'}</td>
                <td style="text-align:center;">${Math.floor(timeSec/60)} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                <td style="text-align:center;">${scoreText}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('adminDetailModal').classList.remove('hidden');
    }

    function closeAdminDetail() {
        document.getElementById('adminDetailModal').classList.add('hidden');
    }

</script>
</body>
</html>