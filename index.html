<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Theme Configuration --- */
        :root {
            --primary: #4f46e5;
            --secondary: #6366f1;
            --bg-color: #f8fafc;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: #1e293b;
            scroll-behavior: smooth;
        }

        /* Glassmorphism & Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }

        .menu-card {
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-left-color: var(--primary);
        }

        .menu-bg-icon {
            position: absolute;
            right: -20px;
            bottom: -20px;
            font-size: 7rem;
            opacity: 0.05;
            color: var(--primary);
            z-index: 0;
            transition: all 0.5s ease;
        }

        .menu-card:hover .menu-bg-icon {
            transform: scale(1.2) rotate(-10deg);
            opacity: 0.1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animation Utilities */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Tab Styles */
        .tab-btn {
            position: relative;
            transition: all 0.3s;
        }
        .tab-btn.active {
            color: var(--primary);
            background-color: #eef2ff;
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 3px;
            background-color: var(--primary);
            border-radius: 3px 3px 0 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-40 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <!-- Logo Area -->
            <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-md">
                    <i class="fa-solid fa-graduation-cap text-xl"></i>
                </div>
                <div class="hidden sm:block">
                    <h1 class="text-lg font-bold text-slate-800 leading-tight">KRU DREAM</h1>
                    <p class="text-[10px] text-slate-500 font-semibold tracking-wide uppercase">E-Learning Platform</p>
                </div>
            </div>

            <!-- User Info Area -->
            <div id="userInfo" class="hidden flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <div id="userDisplay" class="text-sm font-bold text-slate-700"></div>
                    <div id="timerDisplay" class="text-xs text-indigo-600 font-mono font-bold hidden bg-indigo-50 px-2 py-0.5 rounded-full inline-block mt-0.5">
                        <i class="fa-regular fa-clock mr-1"></i><span>00:00</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 border-l pl-4 border-slate-200">
                    <button onclick="openProfile()" class="w-9 h-9 rounded-full bg-slate-100 hover:bg-indigo-100 text-slate-600 hover:text-indigo-600 transition flex items-center justify-center relative group" title="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                        <i class="fa-solid fa-chart-pie"></i>
                    </button>
                    <button onclick="logout()" class="w-9 h-9 rounded-full bg-red-50 hover:bg-red-100 text-red-500 hover:text-red-600 transition flex items-center justify-center relative group" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- 1. Login Section (5-Digit Code Only) -->
        <section id="loginSection" class="max-w-md mx-auto fade-in" style="animation-delay: 0.1s;">
            <div class="glass-card p-8 mt-16 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                
                <div class="text-center mb-10">
                    <div class="bg-indigo-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600 text-3xl shadow-inner">
                        <i class="fa-solid fa-user-lock"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                    <p class="text-slate-500 text-sm">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <div class="relative group">
                            <i class="fa-solid fa-key absolute left-4 top-3.5 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                            <input type="text" inputmode="numeric" id="stdCode" maxlength="5" class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-300 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 transition outline-none bg-white text-center text-lg font-bold tracking-widest placeholder:font-normal placeholder:tracking-normal placeholder:text-slate-300" placeholder="XXXXX" onkeyup="if(event.key === 'Enter') handleLogin()">
                        </div>
                    </div>
                    
                    <button onclick="handleLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition transform active:scale-[0.98] flex justify-center items-center gap-2">
                        <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span> <i class="fa-solid fa-arrow-right"></i>
                    </button>
                    
                    <div class="text-center pt-2">
                        <p class="text-xs text-slate-400">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™: <span class="font-mono bg-slate-100 px-1 rounded">99999</span></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Student Dashboard -->
        <section id="studentDashboard" class="hidden fade-in">
            <div id="mainMenu">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-book-bookmark text-indigo-500"></i> ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </h2>
                        <p class="text-slate-500 text-sm mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="topicGrid"></div>
            </div>

            <div id="contentArea" class="hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 shrink-0">
                            <i class="fa-solid fa-book-open"></i>
                        </div>
                        <div>
                            <h2 id="lessonTitle" class="text-lg font-bold text-slate-800 leading-tight">...</h2>
                            <p class="text-xs text-slate-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
                        </div>
                    </div>
                    <button onclick="backToDash()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold text-sm transition flex items-center gap-2">
                        <i class="fa-solid fa-chevron-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π
                    </button>
                </div>

                <div class="glass-card overflow-hidden min-h-[600px] flex flex-col">
                    <div class="flex border-b border-slate-200 bg-slate-50/50">
                        <button id="tab-learn" class="flex-1 py-4 text-center font-bold text-slate-500 hover:text-indigo-600 tab-btn active" onclick="switchContentTab('learn')">
                            <i class="fa-solid fa-file-lines mr-2"></i> ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                        <button id="tab-quiz" class="flex-1 py-4 text-center font-bold text-slate-500 hover:text-indigo-600 tab-btn" onclick="switchContentTab('quiz')">
                            <i class="fa-solid fa-pen-to-square mr-2"></i> ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                        </button>
                    </div>

                    <div class="p-6 md:p-8 flex-grow bg-white">
                        <div id="view-learn" class="prose max-w-none text-slate-700 fade-in">
                            <div id="lessonViewer" class="leading-relaxed"></div>
                        </div>
                        <div id="view-quiz" class="hidden max-w-3xl mx-auto fade-in">
                            <div id="quizArea" class="space-y-8"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Admin Dashboard -->
        <section id="adminDashboard" class="hidden fade-in">
            <div class="bg-slate-800 text-white p-6 rounded-2xl shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-white/10 rounded-lg backdrop-blur-sm">
                        <i class="fa-solid fa-user-shield text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</h2>
                        <p class="text-slate-300 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg font-bold text-sm transition shadow-md">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>

            <div class="flex gap-2 mb-6 border-b border-slate-200 overflow-x-auto pb-1">
                <button onclick="switchAdminTab('monitor')" id="adm-tab-monitor" class="px-6 py-3 font-bold text-indigo-600 border-b-2 border-indigo-600 whitespace-nowrap transition">
                    <i class="fa-solid fa-chart-bar mr-2"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </button>
                <button onclick="switchAdminTab('content')" id="adm-tab-content" class="px-6 py-3 font-bold text-slate-500 hover:text-indigo-600 border-b-2 border-transparent whitespace-nowrap transition">
                    <i class="fa-solid fa-file-pen mr-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤/‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
                </button>
            </div>

            <div id="admin-monitor-view" class="fade-in">
                <div class="glass-card p-6">
                    <div class="flex flex-col lg:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-users-viewfinder text-indigo-500"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </h3>
                        
                        <div class="flex flex-wrap items-center gap-2 bg-slate-100 p-1.5 rounded-lg">
                            <span class="text-xs font-bold text-slate-500 px-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°:</span>
                            <select id="sortStudentSelect" onchange="fetchStudentMonitor()" class="bg-white border-0 text-sm font-medium text-slate-700 rounded-md py-1.5 pl-3 pr-8 shadow-sm focus:ring-2 focus:ring-indigo-500 cursor-pointer outline-none">
                                <option value="recent">üïí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                <option value="score_desc">üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢)</option>
                                <option value="score_asc">üìâ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ô‡πâ‡∏≠‡∏¢ -> ‡∏°‡∏≤‡∏Å)</option>
                                <option value="number_asc">üî¢ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà (‡∏ô‡πâ‡∏≠‡∏¢ -> ‡∏°‡∏≤‡∏Å)</option>
                                <option value="number_desc">üî¢ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà (‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢)</option>
                            </select>
                            <button onclick="fetchStudentMonitor()" class="p-2 bg-white text-indigo-600 rounded-md shadow-sm hover:bg-indigo-50 transition" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-xl border border-slate-200">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-600 uppercase font-bold text-xs tracking-wider">
                                <tr>
                                    <th class="p-4">‡∏ä‡∏±‡πâ‡∏ô/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                    <th class="p-4">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="p-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="p-4 text-center">‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡∏à‡∏ö</th>
                                    <th class="p-4 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°</th>
                                    <th class="p-4 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
                                    <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="monitorTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-content-view" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 fade-in">
                <div class="lg:col-span-4 glass-card p-4 h-[650px] flex flex-col">
                    <button onclick="prepareNewLesson()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl mb-4 shadow-md transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </button>
                    <div class="flex-grow overflow-y-auto pr-1 space-y-2" id="adminLessonList"></div>
                </div>

                <div class="lg:col-span-8 glass-card p-6 h-[650px] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                        <h3 class="text-lg font-bold text-slate-800"><i class="fa-solid fa-pen-to-square text-indigo-500 mr-2"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                        <input type="hidden" id="editId">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                            <input type="text" id="editTitle" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 focus:bg-white transition" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 ‡∏ö‡∏ó‡∏ô‡∏≥">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                            <select id="editCategory" class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 focus:bg-white transition"></select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (HTML)</label>
                        <p class="text-[10px] text-slate-400 mb-1 ml-1">*‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Text, Image URL, YouTube Embed Code</p>
                        <textarea id="editContent" class="w-full px-4 py-3 border border-slate-200 rounded-lg h-48 font-mono text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 focus:bg-white transition leading-relaxed" placeholder="<p>‡πÉ‡∏™‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</p>"></textarea>
                    </div>

                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-slate-700 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h4>
                            <button onclick="openQuestionModal()" class="text-xs bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-50 transition font-bold shadow-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</button>
                        </div>
                        <div id="qList" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 sticky bottom-0 bg-white">
                        <button onclick="deleteLesson()" class="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-bold transition">‡∏•‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ</button>
                        <button onclick="saveLessonToDB()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow-md transition flex items-center gap-2">
                            <i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="mt-auto py-6 text-center text-slate-400 text-sm">
        <p>&copy; 2024 KRU DREAM E-Learning System. All rights reserved.</p>
    </footer>

    <!-- ================= MODALS ================= -->

    <!-- 1. Student Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-indigo-600 p-5 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-id-card"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
                <button onclick="closeModal('profileModal')" class="hover:bg-white/20 w-8 h-8 rounded-full flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex items-center gap-3">
                        <div class="bg-indigo-100 w-10 h-10 rounded-full flex items-center justify-center text-indigo-600 text-xl"><i class="fa-solid fa-hourglass-half"></i></div>
                        <div>
                            <div class="text-xs text-slate-500 uppercase font-bold">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                            <div class="text-xl font-bold text-slate-800"><span id="profileTotalTime">0</span> <span class="text-sm font-normal text-slate-500">‡∏ô‡∏≤‡∏ó‡∏µ</span></div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100 flex items-center gap-3">
                        <div class="bg-green-100 w-10 h-10 rounded-full flex items-center justify-center text-green-600 text-xl"><i class="fa-solid fa-check-double"></i></div>
                        <div>
                            <div class="text-xs text-slate-500 uppercase font-bold">‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>
                            <div class="text-xl font-bold text-slate-800"><span id="profileCompletedCount">0</span> <span class="text-sm font-normal text-slate-500">‡∏ö‡∏ó</span></div>
                        </div>
                    </div>
                </div>
                
                <h4 class="font-bold text-slate-800 mb-3 border-b pb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                <div class="border rounded-xl overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-bold"><tr><th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th class="p-3 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th class="p-3 text-center">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th></tr></thead>
                        <tbody id="profileQuizTable" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Admin Student Detail Modal -->
    <div id="adminDetailModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-slate-800 p-5 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-user-gear"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
                <button onclick="closeModal('adminDetailModal')" class="hover:bg-white/20 w-8 h-8 rounded-full flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-slate-50">
                <div id="admDetailHeader" class="mb-6 pb-4 border-b border-slate-200 bg-white p-4 rounded-xl shadow-sm"></div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-slate-700 font-bold uppercase text-xs">
                            <tr>
                                <th class="p-4">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                <th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                <th class="p-4 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                                <th class="p-4 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                            </tr>
                        </thead>
                        <tbody id="admDetailBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Question Editor Modal -->
    <div id="questionModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4 fade-in">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 transform scale-100 transition-all">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-circle-question text-indigo-500"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h3>
            
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</label>
            <textarea id="qInputText" class="w-full p-3 border border-slate-200 rounded-xl mb-4 h-24 focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 focus:bg-white transition resize-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            
            <div class="flex justify-between items-center mb-2">
                <label class="text-xs font-bold text-slate-500 uppercase">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡∏ï‡∏¥‡πä‡∏Å‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏ñ‡∏π‡∏Å)</label>
                <button onclick="addOptionInput()" class="text-xs bg-green-50 text-green-600 px-2 py-1 rounded-md hover:bg-green-100 transition font-bold border border-green-200">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            </div>
            
            <div id="optionInputsContainer" class="space-y-2 max-h-60 overflow-y-auto mb-6 pr-1 custom-scrollbar"></div>

            <div class="flex justify-end gap-3 pt-4 border-t border-slate-100">
                <button onclick="closeModal('questionModal')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-bold transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveQuestionToMemory()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-md transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        // --- 1. CONFIGURATION ---
        const CONFIG = {
            appName: "‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå",
            supabaseUrl: 'https://gruvotwrukrqwvaudaro.supabase.co', 
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdydXZvdHdydWtycXd2YXVkYXJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzk3NTksImV4cCI6MjA4NDYxNTc1OX0.GkBklU6IxxNgpCZ3FmFdnAwqPGtJLbcyZxlO5YMD3PA',
            units: [
                { id: 'unit1', title: '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1: ‡∏ö‡∏ó‡∏ô‡∏≥', icon: 'fa-1' },
                { id: 'unit2', title: '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á', icon: 'fa-2' },
                { id: 'unit3', title: '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3: ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', icon: 'fa-3' },
                { id: 'unit4', title: '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4: ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡πç‡∏≤‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô', icon: 'fa-4' },
                { id: 'unit5', title: '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 5: ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡πç‡∏≤‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô', icon: 'fa-5' },
            ]
        };

        // --- 2. GLOBAL VARIABLES ---
        let dbClient;
        let currentUser = null;
        let currentLesson = null;
        let studyTimer = null;
        let secondsSpent = 0;
        let editingQuizData = [];
        let allLessonsCache = [];
        let editingQuestionIndex = -1;
        let monitorDataCache = []; 

        // --- 3. INITIALIZATION ---
        try {
            dbClient = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
        } catch (e) { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error'); }

        window.onload = function() {
            initTopicGrid();
            initAdminSelect();
        };

        // --- 4. AUTHENTICATION SYSTEM (Direct check) ---
        async function handleLogin() {
            const code = document.getElementById('stdCode').value.trim();

            if (!code || code.length < 4) {
                return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å', 'warning');
            }

            // Admin Login Bypass
            if (code === '99999') {
                currentUser = { role: 'admin', name: 'Administrator' };
                showSection('adminDashboard');
                fetchLessonsForAdmin();
                fetchStudentMonitor();
                return;
            }

            // Fetch Logic directly (no loading overlay)
            try {
                // Simplified Query: Only check student_code directly
                const { data: user, error } = await dbClient.from('student_progress')
                    .select('*')
                    .eq('student_code', code)
                    .maybeSingle();
                
                if (error) throw error;
                if (!user) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô)');

                // Try to update login time (Fail silently if column missing)
                try {
                    await dbClient.from('student_progress').update({ last_login: new Date() }).eq('id', user.id);
                } catch(e) { console.warn('Update last_login failed (Optional column)'); }

                currentUser = user;
                setupUserUI();
                showSection('studentDashboard');

            } catch (err) {
                console.error(err);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: err.message,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    confirmButtonColor: '#4f46e5'
                });
            }
        }

        function setupUserUI() {
            if (!currentUser.study_time) currentUser.study_time = {};
            if (!currentUser.completed_lessons) currentUser.completed_lessons = [];
            
            // Prioritize correct column names
            const name = currentUser.student_name || currentUser.name || '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            const sClass = currentUser.student_class || '-';
            const sNum = currentUser.student_number || '-';

            document.getElementById('userDisplay').innerHTML = `${name} <span class="opacity-70 font-normal">(${sClass} #${sNum})</span>`;
            document.getElementById('userInfo').classList.remove('hidden');
        }

        function logout() {
            stopLessonTimer();
            currentUser = null;
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('stdCode').value = '';
            showSection('loginSection');
        }

        function showSection(id) {
            ['loginSection', 'studentDashboard', 'adminDashboard'].forEach(sid => {
                document.getElementById(sid).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- 5. UI GENERATION ---
        function initTopicGrid() {
            const grid = document.getElementById('topicGrid');
            grid.innerHTML = '';
            CONFIG.units.forEach((u, idx) => {
                grid.innerHTML += `
                    <div onclick="loadLessonGroup('${u.id}')" class="menu-card glass-card p-6 cursor-pointer bg-white group h-48 flex flex-col justify-center relative">
                        <i class="fa-solid ${u.icon} menu-bg-icon"></i>
                        <div class="relative z-10 pl-2 border-l-4 border-indigo-100 group-hover:border-indigo-500 transition-all pl-4">
                            <span class="text-xs font-bold text-indigo-500 uppercase tracking-wider block mb-1">Chapter 0${idx + 1}</span>
                            <h3 class="text-xl font-bold text-slate-800 leading-tight group-hover:text-indigo-700 transition">${u.title}</h3>
                            <button class="mt-4 text-xs font-bold bg-slate-100 text-slate-500 px-3 py-1.5 rounded-full group-hover:bg-indigo-600 group-hover:text-white transition flex items-center gap-2 w-fit">
                                <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span> <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        function initAdminSelect() {
            const sel = document.getElementById('editCategory');
            sel.innerHTML = '';
            CONFIG.units.forEach(u => sel.innerHTML += `<option value="${u.id}">${u.title}</option>`);
        }

        // --- 6. LEARNING LOGIC ---
        async function loadLessonGroup(catId) {
            try {
                const { data } = await dbClient.from('lessons').select('*').eq('category', catId).maybeSingle();
                
                if (!data) {
                    return Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Admin ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô)', 'info');
                }

                currentLesson = data;
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('contentArea').classList.remove('hidden');
                document.getElementById('lessonTitle').innerHTML = currentLesson.title;
                
                switchContentTab('learn');
            } catch (err) {
                console.error(err);
                Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            }
        }

        function switchContentTab(tab) {
            const btnLearn = document.getElementById('tab-learn');
            const btnQuiz = document.getElementById('tab-quiz');
            const viewLearn = document.getElementById('view-learn');
            const viewQuiz = document.getElementById('view-quiz');

            if (tab === 'learn') {
                btnLearn.classList.add('active'); btnQuiz.classList.remove('active');
                viewLearn.classList.remove('hidden'); viewQuiz.classList.add('hidden');
                
                document.getElementById('lessonViewer').innerHTML = currentLesson.content || '<div class="text-center py-10 text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</div>';
                startTimer();
            } else {
                btnQuiz.classList.add('active'); btnLearn.classList.remove('active');
                viewQuiz.classList.remove('hidden'); viewLearn.classList.add('hidden');
                
                stopLessonTimer();
                renderStudentQuiz();
            }
        }

        function backToDash() {
            stopLessonTimer();
            document.getElementById('contentArea').classList.add('hidden');
            document.getElementById('mainMenu').classList.remove('hidden');
        }

        function startTimer() {
            stopLessonTimer();
            secondsSpent = 0;
            const timerEl = document.getElementById('timerDisplay');
            timerEl.classList.remove('hidden');
            
            studyTimer = setInterval(() => {
                secondsSpent++;
                const m = Math.floor(secondsSpent / 60).toString().padStart(2, '0');
                const s = (secondsSpent % 60).toString().padStart(2, '0');
                timerEl.querySelector('span').innerText = `${m}:${s}`;
            }, 1000);

            if (currentUser.completed_lessons && !currentUser.completed_lessons.includes(currentLesson.id)) {
                currentUser.completed_lessons.push(currentLesson.id);
                dbClient.from('student_progress').update({ completed_lessons: currentUser.completed_lessons }).eq('id', currentUser.id).then().catch(e=>{});
            }
        }

        async function stopLessonTimer() {
            if (studyTimer) {
                clearInterval(studyTimer);
                document.getElementById('timerDisplay').classList.add('hidden');
                
                if (currentUser && currentLesson && currentUser.study_time) {
                    const oldTime = currentUser.study_time[currentLesson.category] || 0;
                    currentUser.study_time[currentLesson.category] = oldTime + secondsSpent;
                    await dbClient.from('student_progress').update({ study_time: currentUser.study_time }).eq('id', currentUser.id).catch(e=>{});
                }
                studyTimer = null;
            }
        }

        // --- 7. QUIZ LOGIC ---
        function renderStudentQuiz() {
            const div = document.getElementById('quizArea');
            div.innerHTML = '';
            
            if (!currentLesson.quiz_data || !currentLesson.quiz_data.length) {
                div.innerHTML = `<div class="text-center py-20 bg-slate-50 rounded-xl border border-dashed border-slate-300"><i class="fa-solid fa-clipboard-question text-4xl text-slate-300 mb-2"></i><p class="text-slate-500">‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p></div>`;
                return;
            }

            div.innerHTML = `
                <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-lg mb-6">
                    <h3 class="font-bold text-indigo-900">‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</h3>
                    <p class="text-sm text-indigo-700">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${currentLesson.quiz_data.length} ‡∏Ç‡πâ‡∏≠ | ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ú‡πà‡∏≤‡∏ô 50%</p>
                </div>
            `;

            currentLesson.quiz_data.forEach((q, i) => {
                let opts = '';
                q.options.forEach((o, oi) => {
                    opts += `
                        <label class="flex items-center p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition group">
                            <div class="relative flex items-center">
                                <input type="radio" name="q_${i}" value="${oi}" class="peer h-5 w-5 cursor-pointer appearance-none rounded-full border border-slate-300 checked:border-indigo-600 checked:bg-indigo-600 transition-all">
                                <div class="pointer-events-none absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100">
                                    <i class="fa-solid fa-check text-[10px]"></i>
                                </div>
                            </div>
                            <span class="ml-3 text-slate-700 font-medium group-hover:text-indigo-900">${o}</span>
                        </label>
                    `;
                });
                
                div.innerHTML += `
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-slate-200"></div>
                        <p class="font-bold text-slate-800 mb-4 text-lg"><span class="text-slate-400 mr-2">Q${i+1}.</span> ${q.question}</p>
                        <div class="space-y-3">${opts}</div>
                    </div>
                `;
            });

            div.innerHTML += `
                <button onclick="submitQuiz()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition transform active:scale-[0.99] mt-4 flex items-center justify-center gap-2 text-lg">
                    <i class="fa-solid fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                </button>
            `;
        }

        async function submitQuiz() {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö?',
                text: "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4f46e5',
                confirmButtonText: '‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô'
            });

            if (!result.isConfirmed) return;

            let score = 0;
            currentLesson.quiz_data.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q_${i}"]:checked`);
                if (sel && parseInt(sel.value) === parseInt(q.correct)) score++;
            });

            const total = currentLesson.quiz_data.length;
            const passed = (score / total) >= 0.5;

            try {
                await dbClient.from('quiz_results').insert([{
                    student_id: currentUser.id, 
                    lesson_id: currentLesson.id, 
                    score: score, 
                    total_score: total, 
                    passed: passed
                }]);
                
                Swal.fire({
                    title: passed ? '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå' : '‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞',
                    html: `<div class="flex justify-center my-4"><div class="w-24 h-24 rounded-full flex items-center justify-center text-3xl font-bold ${passed ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'}">${score}/${total}</div></div>`,
                    confirmButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
                }).then(() => backToDash());

            } catch(e) {
                Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, 'error');
            }
        }

        // --- 8. ADMIN & MONITORING ---
        function switchAdminTab(tab) {
            document.getElementById('admin-monitor-view').classList.toggle('hidden', tab !== 'monitor');
            document.getElementById('admin-content-view').classList.toggle('hidden', tab !== 'content');
            
            const tabMon = document.getElementById('adm-tab-monitor');
            const tabCon = document.getElementById('adm-tab-content');

            if(tab === 'monitor') {
                tabMon.classList.add('border-indigo-600', 'text-indigo-600');
                tabMon.classList.remove('border-transparent', 'text-slate-500');
                tabCon.classList.remove('border-indigo-600', 'text-indigo-600');
                tabCon.classList.add('border-transparent', 'text-slate-500');
                fetchStudentMonitor(); 
            } else {
                tabCon.classList.add('border-indigo-600', 'text-indigo-600');
                tabCon.classList.remove('border-transparent', 'text-slate-500');
                tabMon.classList.remove('border-indigo-600', 'text-indigo-600');
                tabMon.classList.add('border-transparent', 'text-slate-500');
            }
        }

        async function fetchStudentMonitor() {
            try {
                // FIXED: Changed table name to 'student_progress'
                let { data: students } = await dbClient.from('student_progress').select('*');
                
                const { data: results } = await dbClient.from('quiz_results').select('student_id, score');

                students = students.map(s => {
                    const myScores = results ? results.filter(r => r.student_id === s.id) : [];
                    const totalScore = myScores.reduce((acc, curr) => acc + curr.score, 0);
                    let totalTime = 0;
                    if(s.study_time) Object.values(s.study_time).forEach(v => totalTime += v);
                    
                    s.name = s.student_name; 
                    s.student_number = s.student_number; 

                    return { ...s, totalScore, totalTime };
                });

                const sortType = document.getElementById('sortStudentSelect').value;
                students.sort((a, b) => {
                    if (sortType === 'recent') return new Date(b.last_login || 0) - new Date(a.last_login || 0);
                    if (sortType === 'score_desc') return b.totalScore - a.totalScore;
                    if (sortType === 'score_asc') return a.totalScore - b.totalScore;
                    if (sortType === 'number_asc') return (parseInt(a.student_number) || 0) - (parseInt(b.student_number) || 0);
                    if (sortType === 'number_desc') return (parseInt(b.student_number) || 0) - (parseInt(a.student_number) || 0);
                    return 0;
                });

                monitorDataCache = students;
                const tb = document.getElementById('monitorTableBody');
                tb.innerHTML = '';
                
                if(!students.length) {
                    tb.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
                }

                students.forEach((s, idx) => {
                    const progressCount = s.completed_lessons ? s.completed_lessons.length : 0;
                    const lastActive = s.last_login ? new Date(s.last_login).toLocaleString('th-TH', { hour:'2-digit', minute:'2-digit', day:'numeric', month:'short' }) : '-';

                    tb.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                            <td class="p-4">
                                <div class="font-bold text-slate-800">${s.student_class || '-'}</div>
                                <div class="text-xs text-slate-400 font-mono">#${s.student_number || '-'}</div>
                            </td>
                            <td class="p-4 font-mono text-indigo-600 font-bold tracking-wide">${s.student_code || '-'}</td>
                            <td class="p-4 font-medium text-slate-700">
                                ${s.student_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}
                                <div class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-clock-rotate-left mr-1"></i> ${lastActive}</div>
                            </td>
                            <td class="p-4 text-center">
                                <span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs font-bold">${progressCount} ‡∏ö‡∏ó</span>
                            </td>
                            <td class="p-4 text-center text-slate-600 font-mono text-xs">
                                ${Math.floor(s.totalTime/60)} ‡∏ô‡∏≤‡∏ó‡∏µ
                            </td>
                            <td class="p-4 text-center">
                                <span class="font-bold text-green-600">${s.totalScore}</span>
                            </td>
                            <td class="p-4 text-center">
                                <button onclick="viewStudentDetail(${idx})" class="text-xs bg-white border border-slate-200 hover:border-indigo-300 hover:text-indigo-600 px-3 py-1.5 rounded-lg font-bold transition shadow-sm">
                                    <i class="fa-solid fa-eye"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                </button>
                            </td>
                        </tr>
                    `;
                });

            } catch (err) { console.error(err); } 
        }

        async function viewStudentDetail(idx) {
            const s = monitorDataCache[idx];

            document.getElementById('admDetailHeader').innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 text-xl font-bold">
                        ${(s.student_name || '?').charAt(0)}
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">${s.student_name}</h2>
                        <div class="flex gap-4 mt-1 text-xs font-bold text-slate-500 uppercase tracking-wide">
                            <span><i class="fa-solid fa-layer-group"></i> ${s.student_class || '-'}</span>
                            <span><i class="fa-solid fa-hashtag"></i> ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${s.student_number || '-'}</span>
                            <span class="text-indigo-600"><i class="fa-solid fa-key"></i> Code: ${s.student_code || '-'}</span>
                        </div>
                    </div>
                </div>
            `;

            const { data: qResults } = await dbClient.from('quiz_results').select('*').eq('student_id', s.id).order('created_at', {ascending:false});
            const { data: allLessons } = await dbClient.from('lessons').select('id, category');

            const tb = document.getElementById('admDetailBody');
            tb.innerHTML = '';

            CONFIG.units.forEach(u => {
                const targetLesson = allLessons ? allLessons.find(l => l.category === u.id) : null;
                const time = (s.study_time && s.study_time[u.id]) ? Math.floor(s.study_time[u.id]/60) : 0;
                const isFin = targetLesson && s.completed_lessons?.includes(targetLesson.id);

                let scoreDisplay = '<span class="text-slate-300">-</span>';
                if (targetLesson && qResults) {
                    const match = qResults.find(r => r.lesson_id == targetLesson.id);
                    if (match) {
                        const color = match.passed ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                        scoreDisplay = `<span class="${color} px-2 py-0.5 rounded text-xs font-bold">${match.score}/${match.total_score}</span>`;
                    }
                }

                tb.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b border-slate-50 last:border-0">
                        <td class="p-4 text-slate-700 font-medium text-sm">${u.title}</td>
                        <td class="p-4 text-center">${isFin ? '<i class="fa-solid fa-circle-check text-green-500 text-lg"></i>' : '<i class="fa-regular fa-circle text-slate-300 text-lg"></i>'}</td>
                        <td class="p-4 text-center text-slate-600 text-xs font-mono">${time}</td>
                        <td class="p-4 text-center">${scoreDisplay}</td>
                    </tr>
                `;
            });

            document.getElementById('adminDetailModal').classList.remove('hidden');
        }

        // --- 9. CONTENT EDITOR LOGIC ---
        async function fetchLessonsForAdmin() {
            const { data } = await dbClient.from('lessons').select('*').order('category');
            allLessonsCache = data || [];
            const div = document.getElementById('adminLessonList');
            div.innerHTML = '';
            
            allLessonsCache.forEach(l => {
                div.innerHTML += `
                    <div onclick="loadEditor(${l.id})" class="p-4 rounded-xl border border-slate-100 bg-white hover:border-indigo-300 hover:shadow-md cursor-pointer transition group relative">
                        <div class="text-[10px] font-bold text-indigo-500 uppercase tracking-wider mb-1">${l.category}</div>
                        <div class="text-sm font-bold text-slate-700 group-hover:text-indigo-700 truncate pr-6">${l.title}</div>
                        <div class="absolute top-4 right-4 text-slate-300 group-hover:text-indigo-400"><i class="fa-solid fa-pen"></i></div>
                    </div>
                `;
            });
        }

        function prepareNewLesson() {
            document.getElementById('editId').value = '';
            document.getElementById('editTitle').value = '';
            document.getElementById('editContent').value = '';
            editingQuizData = [];
            renderQuizList();
            if(window.innerWidth < 1024) document.getElementById('admin-content-view').scrollIntoView({behavior:'smooth'});
        }

        function loadEditor(id) {
            const l = allLessonsCache.find(x => x.id == id);
            if (!l) return;
            document.getElementById('editId').value = l.id;
            document.getElementById('editTitle').value = l.title;
            document.getElementById('editCategory').value = l.category;
            document.getElementById('editContent').value = l.content;
            editingQuizData = l.quiz_data || [];
            renderQuizList();
        }

        function renderQuizList() {
            const div = document.getElementById('qList');
            div.innerHTML = '';
            if (editingQuizData.length === 0) {
                div.innerHTML = '<div class="text-center text-slate-400 text-xs py-4 border border-dashed rounded-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>';
                return;
            }

            editingQuizData.forEach((q, i) => {
                div.innerHTML += `
                    <div class="bg-white border border-slate-200 p-3 rounded-lg text-sm relative group hover:border-indigo-300 transition shadow-sm">
                        <div class="font-bold text-slate-700 pr-16 truncate text-xs"><span class="text-indigo-500 mr-1">Q${i+1}.</span> ${q.question}</div>
                        <div class="text-[10px] text-slate-500 mt-1 bg-slate-100 inline-block px-1.5 rounded">‡πÄ‡∏â‡∏•‡∏¢‡∏Ç‡πâ‡∏≠: ${parseInt(q.correct)+1}</div>
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition flex gap-1">
                            <button onclick="editQ(${i})" class="text-blue-500 hover:bg-blue-50 p-1.5 rounded"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="delQ(${i})" class="text-red-500 hover:bg-red-50 p-1.5 rounded"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        async function saveLessonToDB() {
            const id = document.getElementById('editId').value;
            const payload = {
                title: document.getElementById('editTitle').value,
                category: document.getElementById('editCategory').value,
                content: document.getElementById('editContent').value,
                quiz_data: editingQuizData
            };
            
            if (!payload.title) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning');

            const { error } = id 
                ? await dbClient.from('lessons').update(payload).eq('id', id)
                : await dbClient.from('lessons').insert([payload]);

            if (error) Swal.fire('Error', error.message, 'error');
            else {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                fetchLessonsForAdmin();
            }
        }

        async function deleteLesson() {
            const id = document.getElementById('editId').value;
            if (!id) return;
            
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô?',
                text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢'
            });

            if (result.isConfirmed) {
                await dbClient.from('lessons').delete().eq('id', id);
                fetchLessonsForAdmin();
                prepareNewLesson();
                Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'success');
            }
        }

        // --- Question Modal Helpers ---
        function openQuestionModal() {
            editingQuestionIndex = -1;
            document.getElementById('qInputText').value = '';
            document.getElementById('optionInputsContainer').innerHTML = '';
            for(let i=0; i<4; i++) addOptionInput();
            document.getElementById('questionModal').classList.remove('hidden');
        }

        function addOptionInput(val = '', isCorrect = false) {
            const container = document.getElementById('optionInputsContainer');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 mb-2 bg-slate-50 p-2 rounded-lg border border-slate-200 focus-within:border-indigo-400 transition';
            div.innerHTML = `
                <input type="radio" name="corr_opt" class="w-4 h-4 cursor-pointer text-indigo-600 focus:ring-indigo-500" ${isCorrect ? 'checked' : ''}>
                <input type="text" class="opt-val w-full bg-transparent outline-none text-sm text-slate-700 placeholder-slate-400" value="${val}" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...">
                <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-white transition"><i class="fa-solid fa-xmark"></i></button>
            `;
            container.appendChild(div);
        }

        function saveQuestionToMemory() {
            const q = document.getElementById('qInputText').value.trim();
            const opts = [];
            let corr = -1;
            
            const rows = document.querySelectorAll('#optionInputsContainer > div');
            rows.forEach((r, idx) => {
                const val = r.querySelector('.opt-val').value.trim();
                if (val) {
                    opts.push(val);
                    if (r.querySelector('input[name="corr_opt"]').checked) corr = opts.length - 1;
                }
            });

            if (!q) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°', 'warning');
            if (opts.length < 2) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏Ç‡πâ‡∏≠', 'warning');
            if (corr === -1) return Swal.fire('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'warning');

            const obj = { question: q, options: opts, correct: corr };

            if (editingQuestionIndex === -1) editingQuizData.push(obj);
            else editingQuizData[editingQuestionIndex] = obj;

            renderQuizList();
            closeModal('questionModal');
        }

        function editQ(i) {
            editingQuestionIndex = i;
            const d = editingQuizData[i];
            document.getElementById('qInputText').value = d.question;
            const container = document.getElementById('optionInputsContainer');
            container.innerHTML = '';
            d.options.forEach((o, idx) => addOptionInput(o, idx === parseInt(d.correct)));
            document.getElementById('questionModal').classList.remove('hidden');
        }

        function delQ(i) {
            editingQuizData.splice(i, 1);
            renderQuizList();
        }

        async function openProfile() {
            if(!currentUser) return;
            
            let totalTime = 0;
            if (currentUser.study_time) Object.values(currentUser.study_time).forEach(t => totalTime += t);
            document.getElementById('profileTotalTime').innerText = Math.floor(totalTime / 60);
            
            document.getElementById('profileCompletedCount').innerText = currentUser.completed_lessons ? currentUser.completed_lessons.length : 0;

            const { data: res } = await dbClient.from('quiz_results')
                .select('*, lessons(title, category)')
                .eq('student_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            const tb = document.getElementById('profileQuizTable');
            tb.innerHTML = '';
            
            if (res && res.length > 0) {
                res.forEach(r => {
                    const title = r.lessons ? r.lessons.title : '‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö';
                    const badge = r.passed 
                        ? '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">PASS</span>' 
                        : '<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">FAIL</span>';
                    
                    tb.innerHTML += `
                        <tr class="hover:bg-slate-50 border-b border-slate-50 last:border-0">
                            <td class="p-3 text-slate-500 text-xs">${new Date(r.created_at).toLocaleDateString('th-TH')}</td>
                            <td class="p-3 font-medium text-slate-700 text-xs">${title}</td>
                            <td class="p-3 text-center font-bold text-slate-800 text-sm">${r.score}/${r.total_score}</td>
                            <td class="p-3 text-center">${badge}</td>
                        </tr>
                    `;
                });
            } else {
                tb.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</td></tr>';
            }

            document.getElementById('profileModal').classList.remove('hidden');
        }
    </script>
</body>
</html>
