<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏•‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏¥‡∏á (Pro Version)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô --- */
        :root {
            --primary: #2563eb; 
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }

        /* Layout */
        .container { max-width: 1000px; margin: 0 auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); min-height: 85vh; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 150px; font-family: monospace; }
        
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: 0.2s; text-align: center; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--primary); }
        .btn-outline:hover { background: #eff6ff; }
        
        /* Utilities */
        .hidden { display: none !important; }
        .flex-gap { display: flex; gap: 10px; }
        .badge { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 5px; }
        .badge-time { background: #e0f2fe; color: #075985; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; }

        /* Menu & Viewer */
        .grid-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .menu-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; cursor: pointer; background: #f9fafb; transition: 0.2s; }
        .menu-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-color: var(--primary); background: white; }
        .menu-icon { font-size: 2rem; display: block; margin-bottom: 10px; }
        .lesson-viewer { background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 20px; }
        .lesson-viewer iframe { width: 100%; height: 450px; border: none; border-radius: 6px; }

        /* Admin Table */
        .monitor-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .monitor-table th, .monitor-table td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
        .monitor-table th { background: #f3f4f6; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #22c55e; }

        /* Tabs */
        .tab-btn { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    
    <header class="header">
        <div>
            <h1 style="margin:0; color: var(--primary);">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
            <small style="color: var(--text-sub);">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤ V.3 Pro</small>
        </div>
        <div id="userInfo" class="hidden text-right">
            <span id="userDisplay" style="font-weight: bold;"></span>
            <div id="timerDisplay" class="hidden badge-time" style="margin-top:5px; display:inline-block;">‚è± 00:00</div>
            <br>
            <a href="#" onclick="logout()" style="color: var(--danger); font-size: 0.8rem;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </header>

    <div id="loginSection" class="text-center" style="padding: 40px 0;">
        <h2>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <div style="max-width: 350px; margin: 0 auto;">
            <input type="text" id="stdName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå admin)">
            <input type="text" id="stdClass" placeholder="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏°.2/1)">
            <input type="number" id="stdNumber" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button onclick="handleLogin()" class="btn btn-primary" style="margin-top: 15px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="studentDashboard" class="hidden">
        <div id="mainMenu" class="grid-menu">
            <div onclick="loadLessonGroup('lesson1')" class="menu-card">
                <span class="menu-icon">üñ•Ô∏è</span>
                <b>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏°‡∏Ø</b>
                <div id="progress-lesson1" class="text-sub" style="font-size:0.8rem; margin-top:5px;"></div>
            </div>
            <div onclick="loadLessonGroup('lesson2')" class="menu-card">
                <span class="menu-icon">üõ†Ô∏è</span>
                <b>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</b>
                <div id="progress-lesson2" class="text-sub" style="font-size:0.8rem; margin-top:5px;"></div>
            </div>
            <div onclick="loadLessonGroup('lesson3')" class="menu-card">
                <span class="menu-icon">üì°</span>
                <b>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3: ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</b>
                <div id="progress-lesson3" class="text-sub" style="font-size:0.8rem; margin-top:5px;"></div>
            </div>
        </div>

        <div id="contentArea" class="hidden">
            <div class="header" style="border:none; padding-bottom:0;">
                <h2 id="lessonTitle" style="margin:0;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <button onclick="backToDash()" class="btn btn-outline" style="width:auto;">‚¨Ö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            </div>
            
            <p style="margin-top: 5px; color: var(--text-sub);">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢:</p>
            <div id="subTopicMenu" class="flex-gap" style="flex-wrap: wrap;"></div>

            <div id="lessonViewer" class="lesson-viewer">
                <p class="text-center" style="color:#9ca3af; margin-top:50px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
            </div>
        </div>
    </div>

    <div id="adminDashboard" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:#fef3c7; padding:10px; border-radius:8px;">
            <h3 style="margin:0; color:#92400e;">üîß Admin Control Panel</h3>
            <button onclick="logout()" class="btn btn-danger" style="width:auto; padding:5px 15px; font-size:0.9rem;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin</button>
        </div>

        <div style="display:flex; gap:10px; border-bottom:1px solid #ddd; margin-bottom:15px;">
            <div class="tab-btn active" onclick="switchAdminTab('content')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</div>
            <div class="tab-btn" onclick="switchAdminTab('monitor')">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Real-time)</div>
        </div>

        <div id="admin-tab-content" style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
                <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</h4>
                <div id="adminLessonList" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 5px;"></div>
                <button onclick="prepareNewLesson()" class="btn btn-success" style="margin-top: 10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <div style="flex: 2; min-width: 300px;">
                <h4>Editor</h4>
                <input type="text" id="editTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠">
                <select id="editCategory">
                    <option value="lesson1">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</option>
                    <option value="lesson2">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</option>
                    <option value="lesson3">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</option>
                </select>
                <textarea id="editContent" placeholder="HTML ‡∏´‡∏£‡∏∑‡∏≠ Embed Code"></textarea>
                <input type="hidden" id="editId">
                <div class="flex-gap" style="margin-top: 10px;">
                    <button onclick="saveLessonToDB()" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="deleteLesson()" class="btn btn-danger" style="width: auto;">‡∏•‡∏ö</button>
                </div>
            </div>
        </div>

        <div id="admin-tab-monitor" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span>
                <button onclick="fetchStudentMonitor()" class="btn btn-outline" style="width:auto; padding:5px 10px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ</button>
            </div>
            <div style="overflow-x:auto;">
                <table class="monitor-table">
                    <thead>
                        <tr>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏ä‡∏±‡πâ‡∏ô/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th>‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏° (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                            <th>‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                        </tr>
                    </thead>
                    <tbody id="monitorTableBody">
                        <tr><td colspan="6" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    // --- Config ---
    const SUPABASE_URL = 'https://fddkpkcmkvitjkouxerg.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkZGtwa2Nta3ZpdGprb3V4ZXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NDIxMjQsImV4cCI6MjA4MzAxODEyNH0.7OLB2igeXv3ZbLYQ2AJf-HxGpgyxqjwfAjrDG1rhP3E'; 

    let dbClient;
    try {
        dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) { console.error("DB Error", e); }

    // --- Variables ---
    let currentUser = null;
    let currentLessonId = null;
    let studyTimer = null;
    let secondsSpent = 0;
    let monitorInterval = null;

    // --- Login System ---
    async function handleLogin() {
        if (!dbClient) return alert("Connection Error");
        const name = document.getElementById('stdName').value.trim();
        const sClass = document.getElementById('stdClass').value.trim();
        const code = document.getElementById('stdNumber').value.trim();

        if (!name || !code) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

        // Admin Check
        if (name.toLowerCase() === 'admin' && code === '1234') {
            currentUser = { role: 'admin', name: 'Administrator' };
            switchPage('adminDashboard');
            fetchLessonsForAdmin();
            // Start Monitor Auto-refresh
            fetchStudentMonitor();
            monitorInterval = setInterval(fetchStudentMonitor, 10000); 
            return;
        }

        // Student Check
        let { data: user, error } = await dbClient.from('student_progress').select('*').eq('student_name', name).eq('student_number', code).single();

        if (!user) {
            const { data: newUser, error: err } = await dbClient.from('student_progress')
                .insert([{ 
                    student_name: name, 
                    student_class: sClass, 
                    student_number: code,
                    study_time: {} // Init empty time object
                }]).select().single();
            if (err) return alert("Login Failed: " + err.message);
            user = newUser;
        } else {
            // Update Active Status
            await dbClient.from('student_progress').update({ last_login: new Date() }).eq('id', user.id);
        }

        currentUser = user;
        // Ensure study_time is object
        if(!currentUser.study_time) currentUser.study_time = {};
        if(!currentUser.completed_lessons) currentUser.completed_lessons = [];

        document.getElementById('userDisplay').innerText = `‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${currentUser.student_name}`;
        document.getElementById('userInfo').classList.remove('hidden');
        switchPage('studentDashboard');
        updateStudentMenuProgress();
    }

    function logout() {
        if(currentUser && currentUser.role === 'student' && currentLessonId) {
            stopLessonTimer(); // Save before quit
        }
        clearInterval(monitorInterval);
        location.reload();
    }

    function switchPage(pageId) {
        ['loginSection', 'studentDashboard', 'adminDashboard'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
    }

    // --- Student Logic ---
    async function loadLessonGroup(category) {
        const { data } = await dbClient.from('lessons').select('*').eq('category', category).order('order_index');
        
        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('contentArea').classList.remove('hidden');
        document.getElementById('subTopicMenu').innerHTML = '';
        
        const titles = { 'lesson1': '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1', 'lesson2': '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2', 'lesson3': '‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3' };
        document.getElementById('lessonTitle').innerText = titles[category] || category;

        if(data && data.length > 0) {
            data.forEach((lesson, index) => {
                const isDone = currentUser.completed_lessons.includes(lesson.id);
                const btn = document.createElement('button');
                btn.className = isDone ? "btn btn-success" : "btn btn-outline";
                btn.style.width = "auto";
                btn.innerHTML = `${index+1}. ${lesson.title} ${isDone ? '‚úÖ' : ''}`;
                btn.onclick = () => startLesson(lesson);
                document.getElementById('subTopicMenu').appendChild(btn);
            });
        }
    }

    function startLesson(lesson) {
        // Stop previous timer if any
        stopLessonTimer(); 

        currentLessonId = lesson.id;
        document.getElementById('lessonViewer').innerHTML = `
            <h3 style="border-bottom:1px solid #ddd; padding-bottom:10px;">${lesson.title}</h3>
            <div>${lesson.content}</div>
        `;

        // Start New Timer
        secondsSpent = 0;
        document.getElementById('timerDisplay').classList.remove('hidden');
        studyTimer = setInterval(() => {
            secondsSpent++;
            const mins = Math.floor(secondsSpent / 60).toString().padStart(2, '0');
            const secs = (secondsSpent % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').innerText = `‚è± ${mins}:${secs}`;
        }, 1000);

        // Mark as completed immediately (or you can do it after X seconds)
        if (!currentUser.completed_lessons.includes(lesson.id)) {
            currentUser.completed_lessons.push(lesson.id);
            // Save completion status
            dbClient.from('student_progress').update({ 
                completed_lessons: currentUser.completed_lessons 
            }).eq('id', currentUser.id).then(() => {});
        }
    }

    async function stopLessonTimer() {
        if (currentLessonId && studyTimer) {
            clearInterval(studyTimer);
            document.getElementById('timerDisplay').classList.add('hidden');

            // Calculate total time for this lesson
            const existingTime = currentUser.study_time[currentLessonId] || 0;
            const newTotal = existingTime + secondsSpent;
            currentUser.study_time[currentLessonId] = newTotal;

            // Save to DB
            await dbClient.from('student_progress').update({ 
                study_time: currentUser.study_time,
                last_login: new Date() // Keep alive
            }).eq('id', currentUser.id);

            currentLessonId = null;
            secondsSpent = 0;
        }
    }

    function backToDash() {
        stopLessonTimer(); // Save data
        document.getElementById('contentArea').classList.add('hidden');
        document.getElementById('mainMenu').classList.remove('hidden');
        updateStudentMenuProgress(); // Refresh badges
    }

    function updateStudentMenuProgress() {
        // Show progress on main menu
        const cats = ['lesson1', 'lesson2', 'lesson3'];
        // This is a simple visual update, real logic requires fetching lesson counts.
        // For now, let's just show total time spent per user broadly if needed, 
        // or just leave badges in the sub-menu (which is implemented in loadLessonGroup).
    }

    // --- Admin Logic ---
    function switchAdminTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if(tab === 'content') {
            document.getElementById('admin-tab-content').classList.remove('hidden');
            document.getElementById('admin-tab-monitor').classList.add('hidden');
        } else {
            document.getElementById('admin-tab-content').classList.add('hidden');
            document.getElementById('admin-tab-monitor').classList.remove('hidden');
            fetchStudentMonitor();
        }
    }

    async function fetchLessonsForAdmin() {
        const { data } = await dbClient.from('lessons').select('*').order('category').order('order_index');
        const list = document.getElementById('adminLessonList');
        list.innerHTML = '';
        if(data) {
            data.forEach(l => {
                const item = document.createElement('div');
                item.className = "admin-item";
                item.style.padding="8px"; item.style.borderBottom="1px solid #eee"; item.style.cursor="pointer";
                item.innerHTML = `<span><b>[${l.category}]</b> ${l.title}</span> ‚úèÔ∏è`;
                item.onclick = () => loadIntoEditor(l);
                list.appendChild(item);
            });
        }
    }

    // CMS Editor Functions
    function prepareNewLesson() {
        document.getElementById('editId').value = '';
        document.getElementById('editTitle').value = '';
        document.getElementById('editContent').value = '';
    }
    function loadIntoEditor(l) {
        document.getElementById('editId').value = l.id;
        document.getElementById('editTitle').value = l.title;
        document.getElementById('editCategory').value = l.category;
        document.getElementById('editContent').value = l.content;
    }
    async function saveLessonToDB() {
        const id = document.getElementById('editId').value;
        const payload = {
            title: document.getElementById('editTitle').value,
            category: document.getElementById('editCategory').value,
            content: document.getElementById('editContent').value,
            order_index: Date.now()
        };
        if(!payload.title) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏ß‡∏¢");
        
        if(id) await dbClient.from('lessons').update(payload).eq('id', id);
        else await dbClient.from('lessons').insert([payload]);
        
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
        fetchLessonsForAdmin();
        prepareNewLesson();
    }
    async function deleteLesson() {
        const id = document.getElementById('editId').value;
        if(id && confirm("‡∏•‡∏ö‡πÑ‡∏´‡∏°?")) {
            await dbClient.from('lessons').delete().eq('id', id);
            fetchLessonsForAdmin();
            prepareNewLesson();
        }
    }

    // --- Admin Monitor Logic ---
    async function fetchStudentMonitor() {
        const { data: students } = await dbClient.from('student_progress')
            .select('*')
            .order('last_login', { ascending: false });

        const tbody = document.getElementById('monitorTableBody');
        tbody.innerHTML = '';

        if(students) {
            students.forEach(std => {
                // Calculate Status
                const lastLogin = new Date(std.last_login);
                const now = new Date();
                const diffMins = (now - lastLogin) / 1000 / 60;
                const isOnline = diffMins < 5; // Active within 5 mins

                // Calculate Total Time
                let totalSeconds = 0;
                if(std.study_time) {
                    Object.values(std.study_time).forEach(t => totalSeconds += t);
                }
                const totalMins = Math.floor(totalSeconds / 60);

                // Count Completed
                const doneCount = std.completed_lessons ? std.completed_lessons.length : 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="status-dot ${isOnline ? 'online' : ''}"></span>${isOnline ? 'Online' : 'Offline'}</td>
                    <td>${std.student_name}</td>
                    <td>${std.student_class} #${std.student_number}</td>
                    <td class="text-center"><span class="badge">${doneCount} ‡∏ö‡∏ó</span></td>
                    <td class="text-center">${totalMins} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                    <td style="font-size:0.8rem; color:#666;">${lastLogin.toLocaleString('th-TH')}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
</script>
</body>
</html>